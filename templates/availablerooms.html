<!DOCTYPE html>
<html>

<head>
    <title>TigerDraw</title>
    <link rel="icon" href="{{ url_for('static', filename='assets/img/finder.png') }}">
    <meta charset="utf-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">

    <!-- Link jQuery Confirm -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

    <!-- Bootstrap Icons for AC and Bathroom icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Link Notyf CSS Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <!-- Link Notyf JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2P8PYDHQZ7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-2P8PYDHQZ7');
    </script>

</head>
<style>
    .btn-primary {
        border-color: #474bc9 !important;
    }

    .page-item.active .page-link {
        z-index: 1;
        color: #fff !important;
        background-color: #474bc9 !important;
        border-color: #474bc9 !important;
    }

    .page-link {
        position: relative;
        display: block;
        padding: 0.5rem 0.75rem;
        margin-left: -1px;
        line-height: 1.25;
        color: #474bc9 !important;
        background-color: #fff;
        border: 1px solid #dee2e6;
    }

    /* Custom styles for the search bar */
    .search-bar-wrapper {
        transition: all 0.3s ease;
        border-radius: 10px !important;
        border: 1px solid #e0e0e0 !important;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        background-color: #fff;
    }

    .search-bar-wrapper:focus-within {
        box-shadow: 0 0 0 2px rgba(120, 132, 241, 0.25);
    }

    #search {
        border: none;
        height: 54px;
        padding-left: 20px;
        font-size: 16px;
        box-shadow: none !important;
        flex: 1;
    }
    
    #search-specifics-btn {
        transition: all 0.3s ease;
        border: none;
        background-color: #f8f9fa;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        color: #6c757d;
        white-space: nowrap;
        border-left: 1px solid #e0e0e0;
        font-size: 16px;
        min-width: 180px;
        text-align: center;
    }

    #search-specifics-btn:hover {
        background-color: #e9ecef !important;
        color: #495057;
    }

    .search-container {
        max-width: 1000px; 
        margin: 0 auto;
    }

    .search-filters {
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        border-radius: 10px !important;
        border: 1px solid #e8e8e8;
        background-color: #f9f9f9;
        margin-top: 8px;
        padding: 12px 20px;
        display: none;
    }
    
    .search-filters label {
        font-weight: 500;
        margin-bottom: 6px;
        color: #333;
    }
    
    .search-filters .form-control {
        border-radius: 8px;
        height: 38px;
        background-color: #fff;
        border: 1px solid #ddd;
    }
    
    .amenities-heading {
        font-weight: 500;
        margin-bottom: 10px;
        color: #333;
    }
    
    .amenities-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        margin-top: 10px;
    }

    /* Custom toggle switch styling */
    .toggle-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        padding: 4px 0;
        min-width: 200px;
    }
    
    .toggle-label {
        display: flex;
        align-items: center;
        margin-right: 10px;
        cursor: pointer;
        user-select: none;
        font-size: 15px;
        flex: 1;
    }
    
    .toggle-label span {
        margin-left: 2px;
    }
    
    .icon-container {
        width: 30px;
        height: 30px;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .icon-container img, 
    .icon-container i {
        width: 24px;
        height: 24px;
        color: #7884F1;
    }
    
    /* Toggle switch styling to match mockup */
    .custom-switch {
        padding-left: 0;
        position: relative;
        width: 54px;
        height: 18px;
        margin: 0;
        flex-shrink: 0;
    }
    
    .custom-switch .custom-control-label {
        padding-left: 0;
        margin: 0;
        width: 100%;
        height: 100%;
    }
    
    .custom-switch .custom-control-input {
        position: absolute;
        opacity: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .custom-switch .custom-control-label::before {
        position: absolute;
        width: 54px;
        height: 18px;
        border-radius: 9px;
        background-color: #e0e0e0;
        border: none;
        left: 0;
        top: 0;
        transition: background-color 0.15s ease-in-out;
        box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #7884F1;
        border-color: #7884F1;
    }
    
    .custom-switch .custom-control-label::after {
        position: absolute;
        top: 2.5px !important;
        left: 2px;
        width: 14px;
        height: 14px;
        background-color: #fff;
        border-radius: 50%;
        transition: transform 0.15s ease-in-out;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(36px);
        background-color: #fff;
    }
    
    .custom-switch .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 1px #fff, 0 0 0 0.2rem rgba(120, 132, 241, 0.25);
    }
    
    /* Room table icons */
    .amenity-icon {
        line-height: 0;
    }
    
    .table-amenity-icon {
        width: 28px;
        height: 28px;
        position: relative;
        display: inline-block;
    }
    
    .table-amenity-icon.disabled::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 24 24' fill='none' stroke='%23dc3545' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='4.93' y1='4.93' x2='19.07' y2='19.07'%3E%3C/line%3E%3C/svg%3E");
        background-size: contain;
    }
    
    .table-icon-img {
        width: 28px;
        height: 28px;
    }

    .rooms-table {
        font-size: 0.9em;
        min-width: 800px;
        box-shadow: 10px 10px 20px rgba(120, 132, 241, 0.15);
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        top: 50%;
        left: 50%;
        margin-right: auto;
        margin-left: auto;
    }

    .rooms-table thead tr {
        background-color: #7884F1;
        color: #FFFFFF;
        text-align: left;
        font-weight: bold;
    }

    .rooms-table th,
    .rooms-table td {
        padding: 12px 15px;
    }

    td {
        vertical-align: middle !important;
    }

    .rooms-table tbody tr {
        border-bottom: thin solid #7884F1;
    }


    .star {
        visibility: hidden;
        font-size: 1.5em;
        cursor: pointer;
        display: inline-block;
    }

    .star:before {
        content: "\2661";
        visibility: visible;
        position: absolute;
        color: #F15156;
    }

    .star:checked:before {
        content: "\2665";
        color: #F15156;
    }

    textarea {
        resize: none;
    }

    #count_message {
        background-color: #474bc9 !important;
        color: white !important;
        margin-top: -20px;
        margin-right: 5px;
    }

    h2 {
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        text-align: center;
        font-weight: normal;
        font-size: 2em;
        margin-top: 20px;
    }

    .help-tip {
        position: absolute;
        top: 18px;
        right: 18px;
        text-align: center;
        background-color: #7884F1;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 26px;
        cursor: default;
        margin-top: -20px;
        z-index: 1;
    }

    .help-tip:before {
        content: '?';
        font-weight: bold;
        color: #fff;
    }

    .help-tip:hover p {
        display: block;
        transform-origin: 100% 0%;

        -webkit-animation: fadeIn 0.3s ease-in-out;
        animation: fadeIn 0.3s ease-in-out;

    }

    .help-tip p {
        /* The tooltip */
        display: none;
        text-align: left;
        background-color: #7884F1;
        padding: 10px;
        width: 300px;
        position: absolute;
        border-radius: 3px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        right: -4px;
        color: #FFF;
        font-size: 13px;
        line-height: 1.4;
    }

    .help-tip p:before {
        /* The pointer of the tooltip */
        position: absolute;
        content: '';
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-bottom-color: #7884F1;
        right: 10px;
        top: 40px;
    }

    .help-tip p:after {
        /* Prevents the tooltip from being hidden */
        width: 100%;
        height: 40px;
        content: '';
        position: absolute;
        top: 40px;
        left: 0;
    }


    .announcement-banner {
        width: 100%;
        position: relative; 
        margin-bottom: 0; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .alert-info {
        background-color: #e2efff;
        color: #0c5460;
        border: none;
    }

    .alert-info .alert-link {
        color: #074a5a;
        font-weight: bold;
        text-decoration: underline;
    }

    #rooms-table_filter {
        display: none;
    }

    /* CSS animation */

    @-webkit-keyframes fadeIn {
        0% {
            opacity: 0;
            transform: scale(0.6);
        }

        100% {
            opacity: 100%;
            transform: scale(1);
        }
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 100%;
        }
    }

    /* New styles for the redesigned table layout */
    .room-location {
        padding: 8px 0;
    }
    
    .room-occupancy {
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .room-amenities {
        padding: 12px 0;
    }
    
    .room-location {
        min-height: 90px;
    }
    
    .room-building-number {
        font-size: 1.4em;
        font-weight: 700;
        margin-bottom: 4px;
        display: block;
    }
    
    .room-college {
        font-size: 0.95em;
        color: #666;
        margin-bottom: 6px;
        display: block;
    }
    
    .room-actions {
        display: flex;
        align-items: center;
        margin-top: 6px;
    }
    
    .room-rating {
        margin-bottom: 0;
        color: #f0ad4e;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .star-icon {
        color: #f0ad4e;
        font-size: 1.5em;
        margin-right: 2px;
    }
    
    .rating-number {
        margin-left: 5px;
        font-weight: 600;
        font-size: 1.2em;
    }
    
    .room-stars {
        margin-left: auto;
        padding-left: 10px;
        min-width: 120px;
        text-align: right;
    }
    
    .room-details {
        flex: 1;
    }
    
    .room-location-wrapper {
        width: 100%;
    }
    
    .occupancy-icons {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 5px;
        min-height: 32px;
    }
    
    .person-icon {
        width: 28px;
        height: 28px;
        margin-right: 6px;
        display: inline-block;
        vertical-align: middle;
    }
    
    .room-size {
        display: block;
        font-size: 0.95em;
        margin-top: 8px;
        text-align: center;
        font-weight: 500;
        color: #474bc9;
    }
    
    .amenity-icons {
        display: flex;
        align-items: center;
        flex-direction: row;
    }
    
    .amenity-icon {
        margin-right: 16px;
    }
    
    .table-amenity-icon {
        width: 42px;
        height: 42px;
    }
    
    .table-icon-img {
        width: 42px;
        height: 42px;
    }
    
    .distances {
        font-size: 0.95em;
        color: #444;
        flex: 1;
    }
    
    .distance-item {
        margin-bottom: 2px;
        display: flex;
        align-items: center;
        font-size: 0.85em;
    }
    
    .distance-item i {
        font-size: 0.9em;
        margin-right: 2px;
        width: 14px;
        text-align: center;
    }
    
    .distance-label {
        font-weight: 500;
        width: auto;
        display: inline-block;
        font-size: 0.8em;
        margin-right: 4px;
    }
    
    .distance-value {
        font-weight: 600;
        color: #474bc9;
        font-size: 0.8em;
        white-space: nowrap;
    }
    
    .amenities-divider {
        border-left: 1px solid #e0e0e0;
        margin: 0 15px;
        align-self: stretch;
        height: 40px;
    }
    
    /* Fixed grid layout that doesn't change with screen size */
    .distances-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(2, auto);
        grid-gap: 2px 6px;
    }
    
    /* Responsive classes for hiding elements at different screen widths */
    @media (max-width: 1500px) {
        .hide-xl {
            display: none !important;
        }
    }
    
    @media (max-width: 1300px) {
        .hide-lg {
            display: none !important;
        }
    }
    
    @media (max-width: 1100px) {
        .hide-md {
            display: none !important;
        }
    }
    
    @media (max-width: 900px) {
        .hide-sm {
            display: none !important;
        }
    }
    
    /* Mobile-specific adjustments */
    @media (max-width: 767px) {
        .amenities-container {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .amenities-section {
            width: 100%;
            flex-direction: row;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .amenity-icons {
            justify-content: center;
        }
        
        .amenity-icon {
            margin: 0 10px;
        }
        
        .table-amenity-icon, .table-icon-img {
            width: 36px;
            height: 36px;
        }
        
        .amenities-divider {
            display: none;
        }
        
        .distances-section {
            width: 100%;
        }
        
        .distances-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        /* Only show 4 most important distances on mobile */
        .distance-item:nth-child(n+5) {
            display: none !important;
        }
        
        /* Make distance items more compact */
        .distance-item {
            margin-bottom: 1px;
        }
        
        .distance-label {
            font-size: 0.75em;
        }
        
        .distance-value {
            font-size: 0.75em;
        }
    }
    
    /* Very small screen adjustments */
    @media (max-width: 480px) {
        .distances-grid {
            grid-template-columns: repeat(1, 1fr);
        }
        
        /* Only show 2 most important distances on very small screens */
        .distance-item:nth-child(n+3) {
            display: none !important;
        }
        
        /* Even smaller amenity icons */
        .table-amenity-icon, .table-icon-img {
            width: 32px;
            height: 32px;
        }
    }
    
    .amenities-container {
        display: flex;
        align-items: center;
        width: 100%;
        flex-wrap: nowrap; /* Prevent wrapping to keep horizontal layout */
    }
    
    .amenities-section {
        display: flex;
        flex-direction: column;
        min-width: 110px;
        flex-shrink: 0; /* Prevent this section from shrinking */
    }
    
    .distances-section {
        flex: 1;
        overflow: hidden; /* Ensure content doesn't overflow */
    }
    
    .section-heading {
        font-size: 0.75rem;
        font-weight: 600;
        color: #666;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        text-transform: uppercase;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    
    .rooms-table td {
        vertical-align: middle !important;
        padding: 12px 15px;
    }
    
    .review-btn, .add-room-btn {
        background-color: #474bc9 !important;
        color: white !important;
        border: none !important;
        padding: 8px 16px !important;
        border-radius: 6px !important;
        font-weight: 500 !important;
    }
    
    .review-badge {
        background-color: white !important;
        color: #474bc9 !important;
        font-weight: 700 !important;
        margin-left: 6px !important;
    }
    
    /* Ensure proper vertical alignment */
    #rooms-table td {
        vertical-align: middle !important;
    }
    
    /* Make the row taller to accommodate vertical layout */
    #rooms-table tr {
        min-height: 80px;
    }
    
    /* Star styling for favorites */
    .favorite-heart {
        position: relative;
        font-size: 1.5em;
        color: #F15156;
        margin-right: 12px;
        cursor: pointer;
        display: inline-block;
    }

    .heart-checkbox {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }
    
    /* Add room checkmark button */
    .add-room-checkbox {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        cursor: pointer;
        background-color: #eeeeff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0;
        margin-left: 6px;
    }
    
    .add-room-checkbox svg {
        width: 20px;
        height: 20px;
        fill: #474bc9;
    }
    
    .add-room-checkbox:hover {
        background-color: #e0e0ff;
    }
    
    /* Fix table cell widths for new layout with responsive breakpoints */
    #rooms-table th:nth-child(1), #rooms-table td:nth-child(1) { width: 22%; } /* Location */
    #rooms-table th:nth-child(2), #rooms-table td:nth-child(2) { width: 18%; } /* Occupancy */
    #rooms-table th:nth-child(3), #rooms-table td:nth-child(3) { width: 45%; } /* Amenities & Distances */
    #rooms-table th:nth-child(4), #rooms-table td:nth-child(4) { width: 15%; } /* Reviews */
    
    /* Responsive adjustments for column widths */
    @media (max-width: 1200px) {
        #rooms-table th:nth-child(3), #rooms-table td:nth-child(3) { width: 40%; } /* Reduce amenities width */
    }
    
    @media (max-width: 992px) {
        #rooms-table th:nth-child(1), #rooms-table td:nth-child(1) { width: 25%; } /* Increase location */
        #rooms-table th:nth-child(2), #rooms-table td:nth-child(2) { width: 20%; } /* Increase occupancy */
        #rooms-table th:nth-child(3), #rooms-table td:nth-child(3) { width: 35%; } /* Further reduce amenities */
        #rooms-table th:nth-child(4), #rooms-table td:nth-child(4) { width: 20%; } /* Increase reviews */
    }
    
    /* Mobile table adjustments */
    @media (max-width: 767px) {
        #rooms-table th:nth-child(1), #rooms-table td:nth-child(1) { width: 30%; } /* Location takes more space */
        #rooms-table th:nth-child(2), #rooms-table td:nth-child(2) { width: 15%; } /* Reduce occupancy slightly */
        #rooms-table th:nth-child(3), #rooms-table td:nth-child(3) { width: 40%; } /* Keep amenities prominent */
        #rooms-table th:nth-child(4), #rooms-table td:nth-child(4) { width: 15%; } /* Reviews */
        
        /* Increase the row height on mobile to fit stacked content */
        #rooms-table td {
            padding: 15px 8px;
        }
    }
    
    /* Better table design */
    #rooms-table {
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    #rooms-table th {
        background-color: white;
        color: #333333;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9em;
        letter-spacing: 0.5px;
        padding: 12px 16px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    #rooms-table tr:nth-child(even) {
        background-color: rgba(236, 237, 255, 0.4);
    }
    
    #rooms-table tr:hover {
        background-color: rgba(236, 237, 255, 0.7);
    }

    /* Pill filter styling */
    .filter-pills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
        padding: 8px 0;
    }
    
    .filter-pill {
        display: flex;
        align-items: center;
        padding: 6px 16px;
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 50px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #495057;
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        user-select: none;
    }
    
    .filter-pill:hover {
        background-color: #e9ecef;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    
    .filter-pill:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .filter-pill.active {
        background-color: rgba(120, 132, 241, 0.1);
        border-color: #7884F1;
        color: #7884F1;
        box-shadow: 0 1px 3px rgba(120, 132, 241, 0.2);
    }
    
    .filter-pill.positive {
        background-color: rgba(40, 167, 69, 0.1);
        border-color: #28a745;
        color: #28a745;
        box-shadow: 0 1px 3px rgba(40, 167, 69, 0.2);
    }
    
    .filter-pill.negative {
        background-color: rgba(220, 53, 69, 0.1);
        border-color: #dc3545;
        color: #dc3545;
        box-shadow: 0 1px 3px rgba(220, 53, 69, 0.2);
    }
    
    .dropdown-pill {
        position: relative;
    }
    
    .pill-dropdown {
        position: absolute; /* Back to absolute positioning */
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 9999; /* Extremely high z-index */
        min-width: 180px;
        max-height: 300px;
        overflow-y: auto;
        display: none;
        animation: dropdownFadeIn 0.2s ease;
        opacity: 0;
        transform: translateY(-10px);
        animation-fill-mode: forwards;
    }
    
    /* Create a container for pill filter buttons with proper z-index */
    .filter-pills-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        width: 100%;
        padding: 8px 0;
        position: relative;
        z-index: 10000; /* Even higher z-index for the container */
    }
    
    @keyframes dropdownFadeIn {
        0% {
            opacity: 0;
            transform: translateY(-10px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .dropdown-item {
        padding: 10px 16px;
        cursor: pointer;
        transition: all 0.15s ease;
        border-bottom: 1px solid #f5f5f5;
        position: relative;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item:hover {
        background-color: #f8f9fa;
        padding-left: 20px;
    }
    
    .dropdown-item.selected {
        background-color: rgba(120, 132, 241, 0.1);
        color: #7884F1;
        font-weight: 500;
    }
    
    .dropdown-item.selected::before {
        content: '✓';
        position: absolute;
        right: 16px;
        color: #7884F1;
    }
    
    .pill-icon {
        width: 18px;
        height: 18px;
        margin-right: 6px;
    }
    
    /* Update search filter styling */
    .search-filters {
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        border-radius: 10px !important;
        border: 1px solid #e8e8e8;
        background-color: #f9f9f9;
        margin-top: 8px;
        padding: 4px 12px;
        display: none;
    }
    
    /* Keep existing toggle styling to ensure compatibility */
    .custom-switch {
        padding-left: 0;
        position: relative;
        width: 54px;
        height: 18px;
        margin: 0;
        flex-shrink: 0;
    }
    
    .custom-switch .custom-control-label {
        padding-left: 0;
        margin: 0;
        width: 100%;
        height: 100%;
    }
    
    .custom-switch .custom-control-input {
        position: absolute;
        opacity: 0;
        z-index: 1;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .custom-switch .custom-control-label::before {
        position: absolute;
        width: 54px;
        height: 18px;
        border-radius: 9px;
        background-color: #e0e0e0;
        border: none;
        left: 0;
        top: 0;
        transition: background-color 0.15s ease-in-out;
        box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #7884F1;
        border-color: #7884F1;
    }
    
    .custom-switch .custom-control-label::after {
        position: absolute;
        top: 2.5px !important;
        left: 2px;
        width: 14px;
        height: 14px;
        background-color: #fff;
        border-radius: 50%;
        transition: transform 0.15s ease-in-out;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .custom-switch .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(36px);
        background-color: #fff;
    }
    
    .custom-switch .custom-control-input:focus ~ .custom-control-label::before {
        box-shadow: 0 0 0 1px #fff, 0 0 0 0.2rem rgba(120, 132, 241, 0.25);
    }
</style>

<body data-username={{ username }}>

{% with page='rooms' %}
{% include 'navbar.html' %}
{% endwith %}

<!-- Modal for adding groups -->
{% include 'add_room_modal.html' %}

{% include 'see_reviews_modal.html' %}

{% include 'updates_modal.html' %}


<!--{#-->
<!--<div style="padding:10px; background: #474bc9; text-align: center;">#}-->
<!--       <h5 style="font-weight:500; color: white; margin: 0;">Visit <a
            style="color: white; text-decoration: underline; font-weight: bold;"
            target="_blank"
            href="https://rooms.tigerapps.org/">rooms.tigerapps.org</a> to view room reviews and
          search/sort through the 2022-2023 rooms list!</h5>
      <br>
      <h5 style="font-weight:500; color: white; margin: 0;">Floor plans for NCW, NCE, and all other
          buildings can be accessed <a style="color: white; text-decoration: underline;"
            target="_blank"
            href="https://sp2016.princeton.edu/uservices/housing/floorplans/undergraduate/default.aspx">HERE</a>.
      </h5>
      <br> -->
<!--    {# <h3 style=" font-weight:500; color: white; margin-bottom: 0px">Due to high amount of user traffic, you may have-->
<!--        to#}-->
<!--        {# wait at most 3 minutes for the site to fully load.</h3>#}-->


<!--    {#-->
<!--</div>-->
<!--#}-->

<!-- <div style="padding:10px; background: #474bc9; text-align: center;">
    <h3 style=" font-weight:500; color: white; margin-bottom: 0px">Due to high amount of user traffic, you may have to wait at most 3 minutes for the site to fully load.</h3>
</div> -->


<div class="container" style="margin-top: 25px;">
    <div class="row">
        <div class="col text-center">
            <button class="btn btn-primary" style="background: #474bc9;font-weight: bold" data-toggle="modal"
                    data-target="#updatesModal">View TigerDraw Updates
            </button>
        </div>
    </div>
</div>

<div style="padding-top:25px;">
    <h2 style="font-weight:700;">Rooms</h2>
    <p class="text-center mx-2">Browse <b>{{ total_reviews }}</b> reviews (and counting!) across <b>{{ total_rooms }}</b> rooms.</p>
    <p class="text-center mx-2">Select a Residential College to get started. Please find your room and <b>leave an honest review</b> for future inhabitants!</p>
    <p class="text-center mx-2 text-muted small"><i>Tip: Click on column headers to sort rooms by location, rating, occupancy, or amenities</i></p>
    <!-- <p class="text-center mx-2 font-italic">Note: Data comes from the 2017 and 2019 draws. Check the official rooms list for up-to-date information.</p> -->
    <div class="announcement-banner alert alert-info text-center mb-0" role="alert">
        <strong>Do you have a room draw PDF?</strong>
        <a href="https://rooms.tigerapps.org/" class="alert-link" target="_blank" rel="noopener noreferrer">Upload it here</a>
        to see what rooms are still available.
      </div>
</div>

<!-- New Search Bar Implementation -->
<div class="container mt-4">
    <div class="search-container">
        <div class="search-bar-wrapper d-flex">
            <input type="text" id="search" class="form-control" placeholder="Search for a room!">
            <button id="search-specifics-btn" class="btn">
                Search by specifics
            </button>
        </div>
        
        <!-- Expandable filters section with pill-style design -->
        <div id="search-filters" class="search-filters row">
            <div class="filter-pills-container">
                <!-- Favorites filter pill -->
                <div class="filter-pill" id="favorites-pill">
                    <i class="bi bi-heart-fill mr-1"></i> Favorites
                </div>
                
                <!-- College filter pill with dropdown -->
                <div class="filter-pill dropdown-pill" id="college-pill">
                    <span>College</span>
                    <i class="bi bi-chevron-down ml-1"></i>
                    <div class="pill-dropdown college-dropdown">
                        <div class="dropdown-item" data-value="">All</div>
                        <div class="dropdown-item" data-value="Butler College">Butler</div>
                        <div class="dropdown-item" data-value="Forbes College">Forbes</div>
                        <div class="dropdown-item" data-value="Mathey College">Mathey</div>
                        <div class="dropdown-item" data-value="New College West">New College West</div>
                        <div class="dropdown-item" data-value="Rockefeller College">Rocky</div>
                        <div class="dropdown-item" data-value="Whitman College">Whitman</div>
                        <div class="dropdown-item" data-value="Upperclass">Upperclassman</div>
                        <div class="dropdown-item" data-value="Yeh College">Yeh</div>
                    </div>
                </div>
                
                <!-- Building filter pill with dropdown -->
                <div class="filter-pill dropdown-pill" id="building-pill">
                    <span>Building</span>
                    <i class="bi bi-chevron-down ml-1"></i>
                    <div class="pill-dropdown building-dropdown">
                        <div class="dropdown-item" data-value="">All</div>
                        <!-- Building options will be populated dynamically -->
                    </div>
                </div>
                
                <!-- People/Occupancy filter pill with dropdown -->
                <div class="filter-pill dropdown-pill" id="people-pill">
                    <span>People</span>
                    <i class="bi bi-chevron-down ml-1"></i>
                    <div class="pill-dropdown occupancy-dropdown">
                        <div class="dropdown-item" data-value="">All</div>
                        <div class="dropdown-item" data-value="1">1</div>
                        <div class="dropdown-item" data-value="2">2</div>
                        <div class="dropdown-item" data-value="3">3</div>
                        <div class="dropdown-item" data-value="4">4</div>
                        <div class="dropdown-item" data-value="5">5</div>
                        <div class="dropdown-item" data-value="6">6</div>
                    </div>
                </div>
                
                <!-- Size filter pill with dropdown -->
                <div class="filter-pill dropdown-pill" id="size-pill">
                    <span>Size</span>
                    <i class="bi bi-chevron-down ml-1"></i>
                    <div class="pill-dropdown size-dropdown">
                        <div class="dropdown-item" data-value="">All</div>
                        <div class="dropdown-item" data-value="small">Small (&lt;300 sq ft)</div>
                        <div class="dropdown-item" data-value="medium">Medium (300-450 sq ft)</div>
                        <div class="dropdown-item" data-value="large">Large (&gt;450 sq ft)</div>
                    </div>
                </div>
                
                <!-- AC filter toggle pill -->
                <div class="filter-pill toggle-pill" id="ac-pill" data-state="0">
                    <img src="{{ url_for('static', filename='assets/img/ac-icon.svg') }}" alt="AC" class="pill-icon" 
                         onerror="this.onerror=null; this.outerHTML='<i class=\'bi bi-fan pill-icon\'></i>';">
                    <span>A/C</span>
                </div>
                
                <!-- Private Bathroom filter toggle pill -->
                <div class="filter-pill toggle-pill" id="bathroom-pill" data-state="0">
                    <img src="{{ url_for('static', filename='assets/img/bathroom-icon.svg') }}" alt="Bathroom" class="pill-icon"
                         onerror="this.onerror=null; this.outerHTML='<i class=\'bi bi-water pill-icon\'></i>';">
                    <span>Private Bathroom</span>
                </div>
            </div>
            
            <!-- Hidden form elements to maintain compatibility with existing code -->
            <div class="d-none">
                <select id="college" name="college"></select>
                <select id="building" name="building"></select>
                <select id="occupancy" name="occupancy"></select>
                <select id="size" name="size"></select>
                <input type="checkbox" id="ac-toggle">
                <input type="checkbox" id="bathroom-toggle">
            </div>
        </div>
    </div>
</div>

<div style="margin-top:20px; padding-left: 75px; padding-right: 75px; padding-bottom: 100px;">
    <div class="table-responsive">
        <table id="rooms-table" class="table table-striped table-bordered">
            <!--       <table id="rooms-table" class="display">
         -->
            <thead>
            <tr>
                <th>Location & Rating</th>
                <th>Occupancy</th>
                <th>Amenities & Distances</th>
                <th>Reviews</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <th>Location & Rating</th>
                <th>Occupancy</th>
                <th>Amenities & Distances</th>
                <th>Reviews</th>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</body>

</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- <script type="text/javascript" charset="utf8"
  src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script>
    // Initialize Notyf globally for notifications throughout the page
    const notyf = new Notyf({
        duration: 5000,
        position: {
            x: 'right',
            y: 'top',
        },
        types: [
            {
                type: 'success',
                backgroundColor: '#4e73df',
                icon: false
            },
            {
                type: 'error',
                backgroundColor: '#dc3545',
                icon: false
            }
        ]
    });
    
    // Ensure the Notyf instance is available globally
    window.notyf = notyf;
    
    let text_max;
    var rt;
    var gt;
    let request = null;
    let controller = null;

    // Keep the original custom search extension for DataTables that was working
    $.fn.dataTable.ext.search.push(
      function(settings, searchData, index, rowData, counter) {
        // Only apply to rooms-table
        if (settings.nTable.id !== 'rooms-table') {
          return true;
        }
        
        const searchValue = $('#search').val().toLowerCase().trim();
        if (!searchValue) {
          return true; // Show all when no search text
        }
        
        // Safety check
        if (!rowData) return true;
        
        // Check building, college, and room number for matches
        const building = (rowData.building || '').toLowerCase();
        const college = (rowData.res_college || '').toLowerCase();
        const roomNo = (rowData.room_no || '').toLowerCase();
        
        // Direct match check
        if (building.includes(searchValue) || 
            college.includes(searchValue) || 
            roomNo.includes(searchValue) ||
            (building + ' ' + roomNo).includes(searchValue)) {
          return true;
        }
        
        // Handle Forbes/Maine alias
        if ((searchValue.includes('forbes') && building === 'maine') ||
            (searchValue.includes('maine') && college.includes('forbes'))) {
          return true;
        }
        
        // Handle partial matches for building names (for better UX)
        if (searchValue.length >= 3) {
          const buildingWords = building.split(' ');
          const searchWords = searchValue.split(' ');
          
          for (let i = 0; i < searchWords.length; i++) {
            const searchWord = searchWords[i];
            if (searchWord.length >= 3) {
              for (let j = 0; j < buildingWords.length; j++) {
                if (buildingWords[j].includes(searchWord) || searchWord.includes(buildingWords[j])) {
                  return true;
                }
              }
            }
          }
        }
        
        return false;
      }
    );

    function getResults(e) {
        // Use a more robust error mode to prevent freezing
        $.fn.dataTable.ext.errMode = function(settings, helpPage, message) {
            console.error("DataTables error:", message);
        };
        
        let college = $('#college').val();
        // Ensure we're not sending "null" as a string
        college = college ? encodeURIComponent(college) : "";
        
        let occupancy = $('#occupancy').val();
        // Ensure we're not sending "null" as a string
        occupancy = occupancy ? encodeURIComponent(occupancy) : "";
        
        let year = $('#year').val();
        year = year ? encodeURIComponent(year) : "";
        
        let building = $('#building').val();
        if (e && e.data && e.data.change === true) {
            building = "";
        }
        building = building ? encodeURIComponent(building) : "";

        console.log("Sending request with college:", college, "occupancy:", occupancy, "building:", building);
        let url = '/queryrooms?college=' + college + "&occupancy=" + occupancy + "&year=" + year + "&building=" + building

        if (request != null) {
            request.abort();
        }
            
        // Remove any previous search extensions to avoid duplication
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }

        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function (a) {
                a = (a === "UNRANKED") ? Number.POSITIVE_INFINITY : parseFloat(a);
                return a;
            },

            "formatted-num-asc": function (a, b) {
                return a - b;
            },

            "formatted-num-desc": function (a, b) {
                return b - a;
            }
        });

        // added button
        // Custom rating sorter for DataTables
        $.fn.dataTable.ext.order['dom-rating'] = function (settings, col) {
            return this.api().column(col, {order:'index'}).nodes().map(function (td, i) {
                const wrapper = $(td).find('.room-location-wrapper');
                return parseFloat(wrapper.attr('data-rating')) || 0;
            });
        };
        
        rt = $('#rooms-table').DataTable({
            destroy: true,
            searching: true,
            columnDefs: [
                {
                    targets: 0,
                    type: "formatted-num",
                    orderData: 0, // Sort by this column 
                    orderSequence: ['asc', 'desc'],
                    orderDataType: 'dom-rating' // Use our custom sorter
                },
            ],
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            "order": [[0, "desc"]], // Start with highest ratings first
            "pageLength": 20,
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
            },
            "columns": [
                {
                    data: null, 
                    render: function(data, type, row) {
                        // For sorting purposes
                        if (type === 'sort') {
                            return data.building + ' ' + data.room_no;
                        }
                        
                        // Create the favorite heart
                        let heartIcon = data.favorite ? '♥' : '♡';
                        let favoriteHtml = '<label class="favorite-heart">' + heartIcon + 
                                          '<input type="checkbox" class="heart-checkbox star" name="star"' + 
                                          (data.favorite ? ' checked="true"' : '') + '></label>';
                        
                        // Add room checkmark button
                        const addRoomHtml = '<button type="button" class="add-room-checkbox" data-toggle="modal" data-target="#addRoomModal" data-whatever="@getbootstrap" title="Add to group">' +
                                           '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>' +
                                           '</button>';
                        
                        // Generate the star rating HTML with rating number
                        const rating = data.average_rating || 0;
                        const full_stars = Math.floor(rating);
                        const has_half_star = (rating - full_stars) >= 0.5;
                        let empty_stars = 5 - full_stars;
                        if (has_half_star) {
                            empty_stars--;
                        }
                        
                        let ratingHtml = '<div class="room-rating">';
                        for (let i = 0; i < full_stars; i++) {
                            ratingHtml += '<i class="bi bi-star-fill star-icon"></i>';
                        }
                        if (has_half_star) {
                            ratingHtml += '<i class="bi bi-star-half star-icon"></i>';
                        }
                        for (let i = 0; i < empty_stars; i++) {
                            ratingHtml += '<i class="bi bi-star star-icon"></i>';
                        }
                        
                        // Add rating number
                        if (rating > 0) {
                            ratingHtml += '<span class="rating-number">' + rating.toFixed(1) + '</span>';
                        }
                        ratingHtml += '</div>';
                        
                        // Store rating as a data attribute for custom sorting
                        const ratingAttr = 'data-rating="' + (rating || 0) + '"';
                        
                        return '<div class="room-location-wrapper" ' + ratingAttr + '>' +
                               '<div class="room-location d-flex align-items-center">' +
                               '<div class="room-details">' +
                               '<div class="room-building-number">' + data.building + ' ' + data.room_no + '</div>' +
                               '<div class="room-college">' + data.res_college + '</div>' +
                               '<div class="room-actions">' + favoriteHtml + addRoomHtml + '</div>' +
                               '</div>' +
                               '<div class="room-stars">' + ratingHtml + '</div>' +
                               '</div></div>';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        // Create occupancy icons based on the number with larger size
                        let occupancyIcons = '';
                        for (let i = 0; i < data.occupancy; i++) {
                            occupancyIcons += '<img class="person-icon" src="{{ url_for("static", filename="assets/img/person-icon.svg") }}" alt="Person" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-person-fill\\\' style=\\\'font-size: 28px; color: #474bc9;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'">';
                        }
                        
                        return '<div class="room-occupancy d-flex flex-column align-items-center">' +
                               '<div class="occupancy-icons d-flex justify-content-center">' + occupancyIcons + '</div>' +
                               '<div class="room-size"><i class="bi bi-arrows-fullscreen"></i> ' + data.sq_footage + ' sq.ft.</div>' +
                               '</div>';
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        // AC icon with larger size
                        let acIcon = '';
                        if (data.ac && data.ac.trim().toLowerCase() === 'yes') {
                            acIcon = '<div class="amenity-icon"><div class="table-amenity-icon"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/ac-icon.svg") }}" alt="AC" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-fan\\\' style=\\\'font-size: 42px; color: #7884F1;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                        } else {
                            acIcon = '<div class="amenity-icon"><div class="table-amenity-icon disabled"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/ac-icon.svg") }}" alt="No AC" style="opacity: 0.4;" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-fan\\\' style=\\\'font-size: 42px; color: #7884F1; opacity: 0.4;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                        }
                        
                        // Bathroom icon with larger size
                        let bathroomIcon = '';
                        if (data.bathroom) {
                            if (data.bathroom.trim().toLowerCase() === 'private') {
                                bathroomIcon = '<div class="amenity-icon"><div class="table-amenity-icon"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/bathroom-icon.svg") }}" alt="Private Bathroom" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-water\\\' style=\\\'font-size: 42px; color: #7884F1;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                            } else if (data.bathroom.trim().toLowerCase() === 'suite') {
                                bathroomIcon = '<div class="amenity-icon"><div class="table-amenity-icon"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/bathroom-icon.svg") }}" alt="Suite Bathroom" style="opacity: 0.6;" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-water\\\' style=\\\'font-size: 42px; color: #7884F1; opacity: 0.6;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                            } else {
                                bathroomIcon = '<div class="amenity-icon"><div class="table-amenity-icon disabled"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/bathroom-icon.svg") }}" alt="No Bathroom" style="opacity: 0.4;" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-water\\\' style=\\\'font-size: 42px; color: #7884F1; opacity: 0.4;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                            }
                        } else {
                            bathroomIcon = '<div class="amenity-icon"><div class="table-amenity-icon disabled"><img class="table-icon-img" src="{{ url_for("static", filename="assets/img/bathroom-icon.svg") }}" alt="No Bathroom" style="opacity: 0.4;" onerror="this.onerror=null; this.parentNode.innerHTML=\'<i class=\\\'bi bi-water\\\' style=\\\'font-size: 42px; color: #7884F1; opacity: 0.4;\\\'></i>\'; this.src=\'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\'"></div></div>';
                        }
                        
                        // Collect all distances with shorter names
                        const distances = [
                            {name: 'U-Store', value: data.ustore, icon: '<i class="bi bi-shop"></i>'},
                            {name: 'Wawa', value: data.wawa, icon: '<i class="bi bi-bag"></i>'},
                            {name: 'Nassau', value: data['Nassau Street'], icon: '<i class="bi bi-signpost"></i>'},
                            {name: 'Jadwin', value: data['Jadwin Gym'], icon: '<i class="bi bi-bicycle"></i>'},
                            {name: 'Frist', value: data.frist, icon: '<i class="bi bi-building"></i>'},
                            {name: 'E-Quad', value: data.equad, icon: '<i class="bi bi-book"></i>'},
                            {name: 'Dillon', value: data.dillon, icon: '<i class="bi bi-trophy"></i>'},
                            {name: 'Street', value: data.street, icon: '<i class="bi bi-house-door"></i>'}
                        ].filter(dist => dist.value !== undefined && dist.value !== null);
                        
                        // Sort by distance (closest first)
                        distances.sort((a, b) => a.value - b.value);
                        
                        // Create the distance items HTML with responsive class markers
                        let distanceHtml = '<div class="distances-grid">';
                        
                        // Add more granular responsive classes to hide items on smaller screens
                        distances.forEach((dist, index) => {
                            // Determine which responsive class to use based on priority
                            let responsiveClass = '';
                            if (index >= 7) {
                                responsiveClass = 'hide-sm'; // Hide on smallest screens (<900px)
                            } else if (index >= 6) {
                                responsiveClass = 'hide-md'; // Hide on medium-small screens (<1100px)
                            } else if (index >= 5) {
                                responsiveClass = 'hide-lg'; // Hide on medium-large screens (<1300px)
                            } else if (index >= 4) {
                                responsiveClass = 'hide-xl'; // Hide on largest screens (<1500px)
                            }
                            
                            distanceHtml += '<div class="distance-item ' + responsiveClass + '">' + 
                                          dist.icon + ' <span class="distance-label">' + dist.name + '</span>' + 
                                          '<span class="distance-value">' + dist.value + 'm</span>' + 
                                          '</div>';
                        });
                        distanceHtml += '</div>';
                        
                        // Put it all together with a horizontal structure
                        return '<div class="room-amenities">' +
                               '<div class="amenities-container">' +
                               '<div class="amenities-section">' +
                               '<div class="amenity-icons">' + acIcon + bathroomIcon + '</div>' +
                               '</div>' +
                               '<div class="amenities-divider"></div>' +
                               '<div class="distances-section">' +
                               distanceHtml +
                               '</div>' +
                               '</div>' +
                               '</div>';
                    }
                },
                {
                    data: null, 
                    targets: -1,
                    className: 'text-center', 
                    render: function (data, type, row) {
                        return '<button type="button" class="btn review-btn" data-toggle="modal" data-target="#seeReviewsModal" data-whatever="@getbootstrap" onclick="getReviews( \'' + data.building + '\', \'' + data.room_no + '\', this)">Reviews<span class="badge review-badge">' + data.number_of_reviews + '</span></button>';
                    }
                }
            ],
        })

        if (e.data.change === true || typeof (e.data) === "function") {
            rt.ajax.url(url).load(populateDropdowns)
        } else {
            rt.ajax.url(url).load()
        }

    }

    // Store all buildings data for quicker filtering
    let allBuildingsData = {};
    
    // New function to populate ALL buildings regardless of college
    function populateAllBuildings(json) {
        const buildings = [];
        // Don't empty the dropdown here, we'll do it inside updateBuildingDropdownItems
        
        // Make sure we have data to work with
        if (json && json.data && Array.isArray(json.data)) {
            // Create a map of colleges to their buildings
            allBuildingsData = {};
            
            json.data.forEach(function (obj) {
                if (obj.building && obj.res_college) {
                    // Initialize array for this college if needed
                    if (!allBuildingsData[obj.res_college]) {
                        allBuildingsData[obj.res_college] = [];
                    }
                    
                    // Add building if not already in this college's list
                    if (allBuildingsData[obj.res_college].indexOf(obj.building) === -1) {
                        allBuildingsData[obj.res_college].push(obj.building);
                    }
                    
                    // Add to overall buildings list if not already there
                    if (buildings.indexOf(obj.building) === -1) {
                        buildings.push(obj.building);
                    }
                }
            });
            
            // Sort all building lists
            buildings.sort();
            for (let college in allBuildingsData) {
                allBuildingsData[college].sort();
            }
            
            console.log("Building data by college:", allBuildingsData);
            
            // Update building dropdown (the select element)
            $('#building').empty();
            $("#building").append($("<option>").val("").html("All"));
            
            buildings.forEach(function(building) {
                $("#building").append($("<option>").val(building).html(building));
            });
            
            console.log("Populated ALL buildings dropdown with:", buildings);
            
            // Update the UI dropdown as well
            updateBuildingDropdownItems();
        } else {
            console.warn("Unable to populate ALL buildings dropdown - no data available");
        }
    }

    // Optimized dropdown for college-specific buildings with better performance
    function populateDropdowns(json) {
        // Make sure we have data to work with
        if (json && json.data && Array.isArray(json.data)) {
            const collegeFilter = $('#college').val();
            const buildings = new Set(); // Use Set for faster uniqueness checks
            
            // Only process if we have a reasonable amount of data
            if (json.data.length > 0) {
                // First pass: Update college-to-buildings mapping efficiently
                for (let i = 0; i < json.data.length; i++) {
                    const obj = json.data[i];
                    if (obj.res_college && obj.building) {
                        // Initialize college if needed
                        if (!allBuildingsData[obj.res_college]) {
                            allBuildingsData[obj.res_college] = [];
                        }
                        
                        // Add to college's buildings if not already there (faster with Set)
                        const collegeBuildings = new Set(allBuildingsData[obj.res_college]);
                        if (!collegeBuildings.has(obj.building)) {
                            allBuildingsData[obj.res_college].push(obj.building);
                        }
                        
                        // If no college filter or matches current filter, add to buildings Set
                        if (!collegeFilter || obj.res_college === collegeFilter) {
                            buildings.add(obj.building);
                        }
                    }
                }
                
                // Sort all building lists (only once per college)
                for (const college in allBuildingsData) {
                    if (Array.isArray(allBuildingsData[college])) {
                        allBuildingsData[college].sort();
                    }
                }
                
                // Convert Set to sorted Array
                const buildingsArray = Array.from(buildings).sort();
                
                // Update select element with filtered buildings (batched DOM operations)
                const buildingSelect = $('#building');
                buildingSelect.empty();
                
                // Add "All" option
                const fragment = document.createDocumentFragment();
                const allOption = document.createElement('option');
                allOption.value = "";
                allOption.textContent = "All";
                fragment.appendChild(allOption);
                
                // Add building options
                for (let i = 0; i < buildingsArray.length; i++) {
                    const option = document.createElement('option');
                    option.value = buildingsArray[i];
                    option.textContent = buildingsArray[i];
                    fragment.appendChild(option);
                }
                
                // Append all options at once
                buildingSelect[0].appendChild(fragment);
                
                // Reset building selection when college changes to avoid invalid combinations
                if (collegeFilter !== lastFilterState.college) {
                    buildingSelect.val("").attr('data-selected-value', "");
                }
                
                // Update the UI dropdown
                updateBuildingDropdownItems();
            }
        } else {
            console.warn("Unable to populate college buildings dropdown - no data available");
        }
    }

    function getGroups(room_id) {
        let url = '/populategroups?room_id=' + encodeURIComponent(room_id);

        if (request != null)
            request.abort();

        // added button
        gt = $('#groups-table').DataTable({
            "oLanguage": {
                "sEmptyTable": "You are not part of any groups. You may create a group on the Groups page."
            },
            destroy: true,
            searching: false,
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
                "url": url,
            },
            "columns": [
                {
                    "data": "name",
                    "title": "Group Name"
                },
                {
                    targets: 0,
                    className: 'text-center',
                    searchable: false,
                    orderable: false,
                    "data": "favorited",
                    "title": "In group?",
                    render: function (data, type, full, meta) {
                        if (full.favorited === true) {
                            return '<input type="checkbox" class="checkbox" name="star" checked="true">';
                        } else {
                            return '<input type="checkbox" class="checkbox" name="star">';
                        }
                    },
                },
            ],
        });

        gt.ajax.url(url).load()
    }

    function setup() {
        // First make sure we have our search function
        addCustomSearchFunction();
        
        // Load all buildings for the initial display
        $.ajax({
            url: '/queryrooms?college=&occupancy=&year=&building=',
            type: 'GET',
            dataType: 'json',
            success: function(json) {
                // Populate buildings dropdown with ALL buildings
                populateAllBuildings(json);
            },
            error: function(xhr, status, error) {
                console.error("Error loading initial buildings:", error);
            }
        });
        
        // Preload all rooms on initial load
        getResults({data: {change: false}});
        
        // Setup filter change handlers
        $('#college').on('change', {change: true}, getResults);
        $('#occupancy').on('change', {}, getResults);
        $('#year').on('change', {}, getResults);
        $('#building').on('change', {}, getResults);

        // Add change handlers for new filters
        $('#size').on('change', function() {
            // Apply size filter when changed
            applyFilters();
        });

        $('#ac-toggle').on('change', function() {
            // Apply AC filter when toggled
            applyFilters();
        });

        $('#bathroom-toggle').on('change', function() {
            // Apply bathroom filter when toggled
            applyFilters();
        });

        // Ensure button text matches initial filter visibility
        if ($('#search-filters').is(':visible')) {
            $('#search-specifics-btn').text('Hide filters');
        } else {
            $('#search-specifics-btn').text('Search by specifics');
        }

        // Search specifics button toggle functionality
        $('#search-specifics-btn').on('click', function() {
            var $filtersDiv = $('#search-filters');
            var $button = $(this);
            
            $filtersDiv.slideToggle(300, function() {
                // This callback runs after the animation completes
                if ($filtersDiv.is(':visible')) {
                    $button.text('Hide filters');
                } else {
                    $button.text('Search by specifics');
                }
            });
        });

        // Set up search handler to directly redraw the table
        $('#search').off('keyup');
        
        // Add search handler that uses our custom search function with debouncing
        $('#search').on('keyup', function() {
            console.log("Searching for:", this.value);
            // Use debounced version to avoid too many redraws
            debouncedSearch();
        });
        
        // Handle pill filter interactions
        setupPillFilters();

        // on clicking stars, either favorite or unfavorite
        $('#rooms-table').on('change', '.heart-checkbox', function () {
            var data = rt.row($(this).closest('tr')).data();
            var changing_row = data;
            
            // Update the heart icon appearance
            if (this.checked) {
                $(this).parent().text('♥');
                $(this).appendTo($(this).parent());
            } else {
                $(this).parent().text('♡');
                $(this).appendTo($(this).parent());
            }

            if (!this.checked) {
                // send message to db to remove from favorites
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeFromFravorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            } else {
                // SEND MESSAGE TO DATABASE TO ADD TO FAVORITES
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addToFavorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            }
        });

        // set up listener for button to add room to group list
        $('#rooms-table').on('click', 'button', function () {
            // get favorites and set up table
            var data = rt.row($(this).parents('tr')).data();
            $("#addRoomModal").attr('data-room-id', data['room_id']);
            getGroups(data['room_id']);

            var data_arr = Object.values(data);
        });

        // on clicking stars, add room to specified group
        $('#groups-table').on('change', '.checkbox', function () {
            var data = gt.row($(this).parents('tr')).data();
            var room_id = $("#addRoomModal").attr('data-room-id');

            var username = $('body').data('username');
            // console.log(username);
            room_and_group = {"room_id": room_id, "group_id": data['group_id'], "username": username};
            if (this.checked !== true) {
                // send message to db to remove room from group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeroomfromgroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            } else {

                // send message to db to add room to group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addroomtogroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            }

        });

    }
    
    // Create a debounced function - delays executing a function until after wait milliseconds
    function debounce(func, wait) {
        let timeout;
        return function() {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }
    
    // Create the debounced version of rt.draw for search
    const debouncedSearch = debounce(function() {
        if (rt) {
            console.log("Running debounced search");
            // First ensure our custom search extension is active
            addCustomSearchFunction();
            // Then draw the table
            rt.draw();
        }
    }, 300);
    
    // Create a completely rewritten dropdown handling approach
    function positionDropdown(pillElement, dropdownElement) {
        // Reset any previous style modifications first
        dropdownElement.attr('style', '');
        
        // Make sure we have default CSS positioning
        dropdownElement.css({
            position: 'absolute',
            top: '100%',  // Position directly below the pill
            left: '0',
            margin: '5px 0 0 0',
            maxHeight: '300px'
        });
        
        // Make sure we're properly contained in the parent
        pillElement.css('position', 'relative');
        
        // Create a dropdown portal container if it doesn't exist
        if ($('#dropdown-portal').length === 0) {
            $('body').append('<div id="dropdown-portal" style="position: absolute; top: 0; left: 0; width: 100%; height: 0; overflow: visible; pointer-events: none; z-index: 10001;"></div>');
        }
        
        // Hide and reset dropdowns
        $('.pill-dropdown').not(dropdownElement).hide();
        
        // Move to portal and show to measure
        const originalParent = dropdownElement.parent();
        dropdownElement.detach().appendTo('#dropdown-portal').css('opacity', 0).show();
        
        // Get pill button position
        const pillOffset = pillElement.offset();
        const pillHeight = pillElement.outerHeight();
        const pillWidth = pillElement.outerWidth();
        const windowHeight = $(window).height();
        const windowWidth = $(window).width();
        
        // Position dropdown relative to the pill
        dropdownElement.css({
            position: 'absolute',
            top: (pillOffset.top + pillHeight + 5) + 'px',
            left: pillOffset.left + 'px',
            'pointer-events': 'auto'
        });
        
        // Measure dropdown
        const dropdownHeight = dropdownElement.outerHeight();
        const dropdownWidth = dropdownElement.outerWidth();
        
        // Check if it would go off bottom of screen
        if (pillOffset.top + pillHeight + 5 + dropdownHeight > windowHeight) {
            // Position above the pill
            dropdownElement.css('top', (pillOffset.top - dropdownHeight - 5) + 'px');
        }
        
        // Check if it would go off right side of screen
        if (pillOffset.left + dropdownWidth > windowWidth) {
            // Align to right edge of the pill
            dropdownElement.css('left', (pillOffset.left + pillWidth - dropdownWidth) + 'px');
        }
        
        // Reattach to original parent and hide for animation
        dropdownElement.detach().appendTo(originalParent).css('opacity', '').hide();
    }
    
    // Setup pill filter interactions
    // Track last filter state to prevent unnecessary redraws
    let lastFilterState = {
        college: '',
        building: '',
        occupancy: '',
        size: '',
        ac: false,
        bathroom: false,
        favorites: false
    };
    
    function setupPillFilters() {
        // Initialize the hidden form elements with default values to show all rooms
        $('#college').val('');
        $('#building').val('');
        $('#occupancy').val('');
        $('#size').val('');
        $('#ac-toggle').prop('checked', false);
        $('#bathroom-toggle').prop('checked', false);
        
        // Set "All" as selected in all dropdowns
        $('.pill-dropdown').each(function() {
            $(this).find('.dropdown-item[data-value=""]').addClass('selected');
        });
        
        // Trigger immediate initial load to show all rooms
        setTimeout(() => {
            applyFilters();
        }, 100);
        
        // Favorites pill
        $('#favorites-pill').on('click', function() {
            $(this).toggleClass('active');
            // Apply filters immediately
            applyFilters();
        });
        
        // Toggle state pills (AC and Bathroom) with immediate filter application
        $('.toggle-pill').on('click', function() {
            const pillElement = $(this);
            const currentState = parseInt(pillElement.attr('data-state'));
            const nextState = (currentState + 1) % 3; // 0 -> 1 -> 2 -> 0
            
            // Remove all state classes first
            pillElement.removeClass('active positive negative');
            
            // Add visual feedback immediately
            if (nextState === 1) {
                pillElement.addClass('positive');
            } else if (nextState === 2) {
                pillElement.addClass('negative');
            }
            
            // Update the data-state attribute
            pillElement.attr('data-state', nextState);
            
            // Handle different states
            if (nextState === 1) {
                // Positive state (green)
                if (pillElement.attr('id') === 'ac-pill') {
                    $('#ac-toggle').prop('checked', true);
                } else if (pillElement.attr('id') === 'bathroom-pill') {
                    $('#bathroom-toggle').prop('checked', true);
                }
            } else if (nextState === 2) {
                // Negative state (red)
                if (pillElement.attr('id') === 'ac-pill') {
                    $('#ac-toggle').prop('checked', false);
                } else if (pillElement.attr('id') === 'bathroom-pill') {
                    $('#bathroom-toggle').prop('checked', false);
                }
            } else {
                // Reset state
                if (pillElement.attr('id') === 'ac-pill') {
                    $('#ac-toggle').prop('checked', false);
                } else if (pillElement.attr('id') === 'bathroom-pill') {
                    $('#bathroom-toggle').prop('checked', false);
                }
            }
            
            // Apply filters immediately
            applyFilters();
        });
        
        // Dropdown pills with improved handling
        $('.dropdown-pill').on('click', function(e) {
            e.stopPropagation();
            const pillElement = $(this);
            const dropdownElement = pillElement.find('.pill-dropdown');
            
            // Close other dropdowns first
            $('.pill-dropdown').not(dropdownElement).slideUp(100);
            
            // Position dropdown before showing it
            positionDropdown(pillElement, dropdownElement);
            
            // Create a clone for the portal if needed
            if ($('#dropdown-portal').length > 0 && !dropdownElement.is(':visible')) {
                const clonedDropdown = dropdownElement.clone(true);
                
                // Get pill position
                const pillOffset = pillElement.offset();
                const pillHeight = pillElement.outerHeight();
                
                // Position the cloned dropdown
                clonedDropdown.appendTo('#dropdown-portal')
                    .css({
                        position: 'absolute',
                        top: (pillOffset.top + pillHeight + 5) + 'px',
                        left: pillOffset.left + 'px',
                        'pointer-events': 'auto',
                        opacity: 0,
                        display: 'block'
                    })
                    .attr('id', 'portal-dropdown')
                    .animate({opacity: 1}, 150);
                
                // Hide original dropdown
                dropdownElement.hide();
                
                // Replace the clone with a simpler, more direct approach
                clonedDropdown.find('.dropdown-item').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const value = $(this).data('value');
                    
                    // First, immediately remove the dropdown for fast UI response
                    $('#portal-dropdown').remove();
                    $('.pill-dropdown').hide();
                    
                    // Store previous value to detect changes
                    const prevCollegeValue = $('#college').val();
                    
                    // Based on dropdown type, update form controls directly
                    if (pillElement.attr('id') === 'college-pill') {
                        // Update pill appearance
                        if (value) {
                            pillElement.addClass('active');
                        } else {
                            pillElement.removeClass('active');
                        }
                        
                        // Set college value
                        $('#college').val(value).attr('data-selected-value', value);
                        
                        // Reset building to match college filter
                        const currentBuilding = $('#building').val();
                        
                        // Check if current building is in this college
                        let buildingInCollege = false;
                        if (currentBuilding && value && allBuildingsData[value]) {
                            buildingInCollege = allBuildingsData[value].includes(currentBuilding);
                        }
                        
                        // If building doesn't belong to the selected college, clear it
                        if (!buildingInCollege && currentBuilding && value) {
                            $('#building').val("").attr('data-selected-value', "");
                            $('#building-pill').removeClass('active');
                            
                            // Show a notification about clearing building filter
                            if (typeof notyf !== 'undefined') {
                                notyf.info(`Building filter cleared as "${currentBuilding}" is not in ${value}`);
                            }
                        }
                        
                        // For either "All" or specific college, make a direct server query
                        const requestUrl = '/queryrooms?college=' + encodeURIComponent(value || '') + 
                                        '&occupancy=' + encodeURIComponent($('#occupancy').val() || '') + 
                                        '&year=&building=' + encodeURIComponent($('#building').val() || '');
                        
                        // Make API request and refresh data - always make a fresh request
                        $.ajax({
                            url: requestUrl,
                            type: 'GET',
                            dataType: 'json',
                            success: function(json) {
                                if (!value) {
                                    // Process data for "All" colleges
                                    const allBuildings = [];
                                    allBuildingsData = {}; // Reset all data
                                    
                                    // Rebuild college->buildings map
                                    json.data.forEach(function(obj) {
                                        if (obj.res_college && obj.building) {
                                            if (!allBuildingsData[obj.res_college]) {
                                                allBuildingsData[obj.res_college] = [];
                                            }
                                            
                                            if (allBuildingsData[obj.res_college].indexOf(obj.building) === -1) {
                                                allBuildingsData[obj.res_college].push(obj.building);
                                            }
                                            
                                            if (allBuildings.indexOf(obj.building) === -1) {
                                                allBuildings.push(obj.building);
                                            }
                                        }
                                    });
                                    
                                    // Sort everything
                                    allBuildings.sort();
                                    for (let college in allBuildingsData) {
                                        allBuildingsData[college].sort();
                                    }
                                    
                                    // Update building dropdown with all buildings
                                    const buildingSelect = $('#building');
                                    buildingSelect.empty().append($("<option>").val("").html("All"));
                                    
                                    allBuildings.forEach(function(building) {
                                        buildingSelect.append($("<option>").val(building).html(building));
                                    });
                                } 
                                else {
                                    // Process data for specific college
                                    const collegeBuildings = [];
                                    
                                    // Get buildings just for this college
                                    json.data.forEach(function(obj) {
                                        if (obj.building && collegeBuildings.indexOf(obj.building) === -1) {
                                            collegeBuildings.push(obj.building);
                                        }
                                    });
                                    
                                    // Sort them
                                    collegeBuildings.sort();
                                    
                                    // Update the building dropdown
                                    const buildingSelect = $('#building');
                                    buildingSelect.empty().append($("<option>").val("").html("All"));
                                    
                                    collegeBuildings.forEach(function(building) {
                                        buildingSelect.append($("<option>").val(building).html(building));
                                    });
                                    
                                    // Store in global map
                                    allBuildingsData[value] = collegeBuildings;
                                }
                                
                                // Update the UI dropdown menus
                                updateBuildingDropdownItems();
                                
                                // Make sure the college dropdown shows the correct selection
                                $('.college-dropdown .dropdown-item').removeClass('selected');
                                if (value) {
                                    $('.college-dropdown .dropdown-item[data-value="' + value + '"]').addClass('selected');
                                } else {
                                    $('.college-dropdown .dropdown-item[data-value=""]').addClass('selected');
                                }
                                
                                // Reload the data table with the new data from the server
                                rt.ajax.url(requestUrl).load();
                            }
                        });
                    } 
                    else if (pillElement.attr('id') === 'building-pill') {
                        // Update pill appearance
                        if (value) {
                            pillElement.addClass('active');
                            
                            // When a building is selected, efficiently find which college it belongs to
                            let belongsToCollege = null;
                            
                            // Create a mapping from building to college if it doesn't exist yet
                            // This is a performance optimization to avoid searching every time
                            if (!window.buildingToCollegeMap) {
                                window.buildingToCollegeMap = {};
                                
                                // Build the mapping once
                                for (const college in allBuildingsData) {
                                    if (allBuildingsData[college] && Array.isArray(allBuildingsData[college])) {
                                        for (const building of allBuildingsData[college]) {
                                            window.buildingToCollegeMap[building] = college;
                                        }
                                    }
                                }
                            }
                            
                            // Update the mapping for this building just in case
                            window.buildingToCollegeMap[value] = window.buildingToCollegeMap[value] || null;
                            
                            // Do a direct lookup instead of searching each time
                            belongsToCollege = window.buildingToCollegeMap[value];
                            
                            // If we found which college this building belongs to
                            if (belongsToCollege) {
                                // First check if we need to change college
                                const currentCollege = $('#college').val();
                                if (currentCollege && currentCollege !== belongsToCollege) {
                                    // We need to change the college filter to match the building
                                    console.log(`Building ${value} belongs to ${belongsToCollege}, updating college filter`);
                                    
                                    // Update college filter UI and value (do DOM operations in batch)
                                    $('#college').val(belongsToCollege).attr('data-selected-value', belongsToCollege);
                                    $('#college-pill').addClass('active');
                                    
                                    // Update dropdown selection
                                    $('.college-dropdown .dropdown-item').removeClass('selected');
                                    $(`.college-dropdown .dropdown-item[data-value="${belongsToCollege}"]`).addClass('selected');
                                    
                                    // Show a notification to the user
                                    if (typeof notyf !== 'undefined') {
                                        notyf.success(`College filter updated to ${belongsToCollege}`);
                                    }
                                }
                            }
                        } else {
                            pillElement.removeClass('active');
                        }
                        
                        // Set value and trigger change
                        $('#building').val(value).attr('data-selected-value', value).trigger('change');
                    }
                    else if (pillElement.attr('id') === 'people-pill') {
                        // Update pill appearance
                        if (value) {
                            pillElement.addClass('active');
                        } else {
                            pillElement.removeClass('active');
                        }
                        
                        // Set value
                        $('#occupancy').val(value).attr('data-selected-value', value);
                        
                        // Trigger change or apply filters
                        if (value) {
                            $('#occupancy').trigger('change');
                        } else {
                            applyFilters();
                        }
                    } 
                    else if (pillElement.attr('id') === 'size-pill') {
                        // Update pill appearance
                        if (value) {
                            pillElement.addClass('active');
                        } else {
                            pillElement.removeClass('active');
                        }
                        
                        // Set value and apply filters
                        $('#size').val(value).attr('data-selected-value', value);
                        applyFilters();
                    }
                });
            } else {
                // Toggle original dropdown with animation
                dropdownElement.slideToggle(150);
            }
        });
        
        // Handle dropdown item selection with improved performance
        $('.dropdown-item').on('click', function(e) {
            e.stopPropagation();
            const itemElement = $(this);
            const value = itemElement.data('value');
            const dropdownElement = itemElement.closest('.pill-dropdown');
            const pillElement = itemElement.closest('.dropdown-pill');
            
            // Show visual feedback immediately
            // Update selection visually
            dropdownElement.find('.dropdown-item').removeClass('selected');
            itemElement.addClass('selected');
            
            // Update pill appearance
            if (value === '') {
                pillElement.removeClass('active');
            } else {
                pillElement.addClass('active');
            }
            
            // Update hidden form controls based on which dropdown was clicked
            if (dropdownElement.hasClass('college-dropdown')) {
                console.log("College dropdown clicked, setting value to:", value);
                
                // Set college value
                $('#college').val(value).attr('data-selected-value', value);
                
                // Update the pill UI immediately
                if (value) {
                    // This is a college selection
                    $('#college-pill').addClass('active');
                    
                    // Reset building to match college filter
                    const currentBuilding = $('#building').val();
                    
                    // Check if current building is in this college
                    let buildingInCollege = false;
                    if (currentBuilding && allBuildingsData[value]) {
                        buildingInCollege = allBuildingsData[value].includes(currentBuilding);
                    }
                    
                    // If building doesn't belong to the selected college, clear it
                    if (!buildingInCollege && currentBuilding) {
                        $('#building').val("").attr('data-selected-value', "");
                        $('#building-pill').removeClass('active');
                        
                        // Show a notification about clearing building filter
                        if (typeof notyf !== 'undefined') {
                            notyf.info(`Building filter cleared as "${currentBuilding}" is not in ${value}`);
                        }
                    }
                } else {
                    // This is "All" colleges
                    $('#college-pill').removeClass('active');
                }
                
                // For either "All" or specific college, make a direct server query
                const requestUrl = '/queryrooms?college=' + encodeURIComponent(value || '') + 
                                '&occupancy=' + encodeURIComponent($('#occupancy').val() || '') + 
                                '&year=&building=' + encodeURIComponent($('#building').val() || '');
                
                // Make API request and refresh data - always make a fresh request
                $.ajax({
                    url: requestUrl,
                    type: 'GET',
                    dataType: 'json',
                    success: function(json) {
                        if (!value) {
                            // Process data for "All" colleges
                            const allBuildings = [];
                            allBuildingsData = {}; // Reset all data
                            
                            // Rebuild college->buildings map
                            json.data.forEach(function(obj) {
                                if (obj.res_college && obj.building) {
                                    if (!allBuildingsData[obj.res_college]) {
                                        allBuildingsData[obj.res_college] = [];
                                    }
                                    
                                    if (allBuildingsData[obj.res_college].indexOf(obj.building) === -1) {
                                        allBuildingsData[obj.res_college].push(obj.building);
                                    }
                                    
                                    if (allBuildings.indexOf(obj.building) === -1) {
                                        allBuildings.push(obj.building);
                                    }
                                }
                            });
                            
                            // Sort everything
                            allBuildings.sort();
                            for (let college in allBuildingsData) {
                                allBuildingsData[college].sort();
                            }
                            
                            // Update building dropdown with all buildings
                            const buildingSelect = $('#building');
                            buildingSelect.empty().append($("<option>").val("").html("All"));
                            
                            allBuildings.forEach(function(building) {
                                buildingSelect.append($("<option>").val(building).html(building));
                            });
                        } 
                        else {
                            // Process data for specific college
                            const collegeBuildings = [];
                            
                            // Get buildings just for this college
                            json.data.forEach(function(obj) {
                                if (obj.building && collegeBuildings.indexOf(obj.building) === -1) {
                                    collegeBuildings.push(obj.building);
                                }
                            });
                            
                            // Sort them
                            collegeBuildings.sort();
                            
                            // Update the building dropdown
                            const buildingSelect = $('#building');
                            buildingSelect.empty().append($("<option>").val("").html("All"));
                            
                            collegeBuildings.forEach(function(building) {
                                buildingSelect.append($("<option>").val(building).html(building));
                            });
                            
                            // Store in global map
                            allBuildingsData[value] = collegeBuildings;
                        }
                        
                        // Update the UI dropdown menus
                        updateBuildingDropdownItems();
                        
                        // Make sure the college dropdown shows the correct selection
                        $('.college-dropdown .dropdown-item').removeClass('selected');
                        if (value) {
                            $('.college-dropdown .dropdown-item[data-value="' + value + '"]').addClass('selected');
                        } else {
                            $('.college-dropdown .dropdown-item[data-value=""]').addClass('selected');
                        }
                        
                        // Also update building pill coloring based on actual state
                        if ($('#building').val()) {
                            $('#building-pill').addClass('active');
                        } else {
                            $('#building-pill').removeClass('active');
                        }
                        
                        // Reload the data table with the new data from the server
                        rt.ajax.url(requestUrl).load();
                    }
                });
            } else if (dropdownElement.hasClass('building-dropdown')) {
                console.log("Building dropdown clicked, setting value to:", value);
                
                if (value) {
                    // When a building is selected, efficiently find which college it belongs to
                    let belongsToCollege = null;
                    
                    // Use the building-to-college mapping if it exists
                    if (window.buildingToCollegeMap && window.buildingToCollegeMap[value]) {
                        belongsToCollege = window.buildingToCollegeMap[value];
                    } else {
                        // Create the mapping if it doesn't exist
                        if (!window.buildingToCollegeMap) {
                            window.buildingToCollegeMap = {};
                            // Build the mapping
                            for (const college in allBuildingsData) {
                                if (allBuildingsData[college] && Array.isArray(allBuildingsData[college])) {
                                    for (const building of allBuildingsData[college]) {
                                        window.buildingToCollegeMap[building] = college;
                                    }
                                }
                            }
                            // Try the lookup again
                            belongsToCollege = window.buildingToCollegeMap[value];
                        } else {
                            // Fallback to the original method if mapping doesn't have this building
                            for (const college in allBuildingsData) {
                                if (allBuildingsData[college] && allBuildingsData[college].includes(value)) {
                                    belongsToCollege = college;
                                    // Update the map for next time
                                    window.buildingToCollegeMap[value] = college;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // If we found which college this building belongs to
                    if (belongsToCollege) {
                        // First check if we need to change college
                        const currentCollege = $('#college').val();
                        if (currentCollege && currentCollege !== belongsToCollege) {
                            // We need to change the college filter to match the building
                            console.log(`Building ${value} belongs to ${belongsToCollege}, updating college filter`);
                            
                            // Update college filter UI and value
                            $('#college').val(belongsToCollege).attr('data-selected-value', belongsToCollege);
                            $('#college-pill').addClass('active');
                            $('.college-dropdown .dropdown-item').removeClass('selected');
                            $(`.college-dropdown .dropdown-item[data-value="${belongsToCollege}"]`).addClass('selected');
                            
                            // Show a notification to the user
                            if (typeof notyf !== 'undefined') {
                                notyf.success(`College filter updated to ${belongsToCollege}`);
                            }
                        }
                    }
                    
                    // Set building filter value and update UI
                    $('#building').val(value).attr('data-selected-value', value);
                    pillElement.addClass('active');
                } else {
                    // Clear building filter
                    $('#building').val("").attr('data-selected-value', "");
                    pillElement.removeClass('active');
                }
                
                // Trigger change to update data
                $('#building').trigger('change');
                
            } else if (dropdownElement.hasClass('occupancy-dropdown')) {
                console.log("Occupancy dropdown clicked, setting value to:", value);
                
                // Update occupancy filter
                $('#occupancy').val(value).attr('data-selected-value', value);
                
                // Update UI
                if (value) {
                    pillElement.addClass('active');
                } else {
                    pillElement.removeClass('active');
                }
                
                // For occupancy, refresh the data immediately
                if (value) {
                    $('#occupancy').trigger('change');
                } else {
                    applyFilters();
                }
            } else if (dropdownElement.hasClass('size-dropdown')) {
                console.log("Size dropdown clicked, setting value to:", value);
                
                // Update size filter
                $('#size').val(value).attr('data-selected-value', value);
                
                // Update UI
                if (value) {
                    pillElement.addClass('active');
                } else {
                    pillElement.removeClass('active');
                }
                
                // Size doesn't trigger a server request, so apply filter explicitly
                applyFilters();
            }
            
            // Hide dropdown after selection
            dropdownElement.hide();
        });
        
        // Close dropdowns when clicking elsewhere
        $(document).on('click', function(e) {
            // Only if we clicked outside any pill
            if (!$(e.target).closest('.dropdown-pill').length) {
                $('.pill-dropdown').slideUp(100);
                $('#portal-dropdown').fadeOut(100, function() {
                    $(this).remove();
                });
            }
        });
        
        // Add event listener for ESC key to close dropdowns
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape') {
                $('.pill-dropdown').slideUp(100);
                $('#portal-dropdown').fadeOut(100, function() {
                    $(this).remove();
                });
            }
        });
        
        // Populate building dropdown items when college changes
        $('#college').on('change', function() {
            const collegeValue = $(this).val();
            console.log("College changed to:", collegeValue);
            
            // This will trigger a server request to get available buildings for this college
            setTimeout(function() {
                updateBuildingDropdownItems();
            }, 100);
            
            // Manually trigger a filter application to update shown rows
            setTimeout(applyFilters, 200);
        });
    }
    
    // Update building dropdown items based on the selected college
    function updateBuildingDropdownItems() {
        const buildingDropdown = $('.building-dropdown');
        const selectedCollege = $('#college').val() || '';
        
        // Cache selected value before emptying dropdown
        const currentBuilding = $('#building').val();
        
        // Completely remove and rebuild the dropdown (faster than manipulating individual items)
        buildingDropdown.empty();
        
        // Always add the "All" option
        buildingDropdown.append('<div class="dropdown-item selected" data-value="">All</div>');
        
        // Determine which buildings to show (with optimized approach)
        let buildingsToShow = [];
        
        if (selectedCollege && allBuildingsData[selectedCollege]) {
            // If a college is selected, show only buildings for that college
            // Shallow copy for better performance
            buildingsToShow = allBuildingsData[selectedCollege].slice(0);
        } else {
            // If no college selected, show all buildings from all colleges (optimized)
            // Use Set for faster uniqueness checks
            const uniqueBuildings = new Set();
            
            for (const college in allBuildingsData) {
                if (allBuildingsData[college] && Array.isArray(allBuildingsData[college])) {
                    // Add all buildings directly to the Set (automatically handles duplicates)
                    allBuildingsData[college].forEach(building => uniqueBuildings.add(building));
                }
            }
            
            // Convert Set to Array
            buildingsToShow = Array.from(uniqueBuildings);
        }
        
        // Sort buildings alphabetically only if buildings were found
        if (buildingsToShow.length > 0) {
            buildingsToShow.sort();
        }
        
        // Only generate HTML if we have buildings to show
        if (buildingsToShow.length > 0) {
            // Create all items at once as HTML string (faster than multiple DOM operations)
            let html = '';
            for (let i = 0; i < buildingsToShow.length; i++) {
                const building = buildingsToShow[i];
                const isSelected = building === currentBuilding ? ' selected' : '';
                html += `<div class="dropdown-item${isSelected}" data-value="${building}">${building}</div>`;
            }
            
            // Add all items at once (single DOM operation)
            buildingDropdown.append(html);
        }
        
        // Use event delegation for performance instead of binding to each item
        buildingDropdown.off('click.buildingItem').on('click.buildingItem', '.dropdown-item', function(e) {
            e.stopPropagation();
            const value = $(this).data('value');
            const pillElement = $(this).closest('.dropdown-pill');
            
            // Batch DOM operations for better performance
            // Update selection visually
            buildingDropdown.find('.dropdown-item').removeClass('selected');
            $(this).addClass('selected');
            
            // Update pill appearance
            pillElement.toggleClass('active', value !== '');
            
            // Update building select and trigger change
            $('#building').val(value).attr('data-selected-value', value);
            
            // Hide dropdown immediately for better UX
            buildingDropdown.hide();
            $('#portal-dropdown').remove();
            
            // Trigger change event after a small delay to allow UI to update first
            setTimeout(() => $('#building').trigger('change'), 0);
        });
        
        // Make sure the correct item is selected to match the hidden form element
        if (currentBuilding) {
            const selectedItem = buildingDropdown.find(`.dropdown-item[data-value="${currentBuilding}"]`);
            if (selectedItem.length) {
                buildingDropdown.find('.dropdown-item').removeClass('selected');
                selectedItem.addClass('selected');
            }
        }
    }
    
    // Overriding the default occupancy selector (prevent options > 6)
    $("#occupancy").on('change', function() {
        const val = $(this).val();
        if (val !== "" && parseInt(val) > 6) {
            $(this).val(6).trigger('change');
            console.warn('Occupancy limited to max 6 people');
        }
    });

    function applyFilters() {
        console.log("Applying filters...");
        
        // Get selected values from data attributes for better reliability
        const selectedCollege = $('#college').attr('data-selected-value') || $('#college').val() || "";
        const selectedOccupancy = $('#occupancy').attr('data-selected-value') || $('#occupancy').val() || "";
        const selectedSize = $('#size').attr('data-selected-value') || $('#size').val() || "";
        const acState = parseInt($('#ac-pill').attr('data-state') || "0");
        const bathroomState = parseInt($('#bathroom-pill').attr('data-state') || "0");
        const favoritesActive = $('#favorites-pill').hasClass('active');
        
        // Check if filter state has actually changed to avoid unnecessary redraws
        const currentState = {
            college: selectedCollege,
            building: $('#building').val() || "",
            occupancy: selectedOccupancy,
            size: selectedSize,
            ac: acState,
            bathroom: bathroomState,
            favorites: favoritesActive
        };
        
        // Skip redraw if nothing has changed
        if (JSON.stringify(lastFilterState) === JSON.stringify(currentState) && 
            $.fn.dataTable.ext.search.length > 0) {
            console.log("Filter state unchanged, skipping redraw");
            return;
        }
        
        // Update last state
        lastFilterState = {...currentState};
        
        // Only reset search functions if needed
        // This prevents unnecessary recreation of functions causing freezing
        if ($.fn.dataTable.ext.search.length === 0) {
            // Add our custom search function if it's not already there
            addCustomSearchFunction();
        } else {
            // Remove all filters except the first one (our custom search)
            while ($.fn.dataTable.ext.search.length > 1) {
                $.fn.dataTable.ext.search.pop();
            }
        }
        
        console.log("Applying filters with college:", selectedCollege);
        console.log("Applying filters with occupancy:", selectedOccupancy);
        console.log("Applying filters with size:", selectedSize);
        
        // Search text is handled by our custom search function at the top of the file
        
        // Create size filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                try {
                    // Only apply to rooms-table
                    if (settings.nTable.id !== 'rooms-table') {
                        return true;
                    }
                    
                    const sizeValue = $('#size').val();
                    if (!sizeValue) {
                        return true; // Show all when no size filter
                    }
                    
                    // Get room data from the DataTable's data
                    const rowData = rt.row(dataIndex).data();
                    if (!rowData) return true; // Safety check
                    
                    const footage = parseInt(rowData.sq_footage);
                    
                    if (isNaN(footage)) {
                        return true; // If we can't parse the footage, just show it
                    }
                    
                    if (sizeValue === 'small' && footage < 300) {
                        return true;
                    } else if (sizeValue === 'medium' && footage >= 300 && footage <= 450) {
                        return true;
                    } else if (sizeValue === 'large' && footage > 450) {
                        return true;
                    }
                    
                    return false;
                } catch (e) {
                    console.error("Error in size filter:", e);
                    return true; // In case of error, show the row
                }
            }
        );
        
        // Create AC filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                try {
                    // Only apply to rooms-table
                    if (settings.nTable.id !== 'rooms-table') {
                        return true;
                    }
                    
                    const acPillState = parseInt($('#ac-pill').attr('data-state'));
                    
                    if (acPillState === 0) {
                        return true; // Show all when toggle is off
                    }
                    
                    // Get room data from the DataTable's data
                    const rowData = rt.row(dataIndex).data();
                    if (!rowData) return true; // Safety check
                    
                    const hasAC = rowData.ac && rowData.ac.trim().toLowerCase() === 'yes';
                    
                    // State 1: Positive (show only rooms WITH AC)
                    // State 2: Negative (show only rooms WITHOUT AC)
                    return (acPillState === 1) ? hasAC : !hasAC;
                } catch (e) {
                    console.error("Error in AC filter:", e);
                    return true; // In case of error, show the row
                }
            }
        );
        
        // Create bathroom filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                try {
                    // Only apply to rooms-table
                    if (settings.nTable.id !== 'rooms-table') {
                        return true;
                    }
                    
                    const bathroomPillState = parseInt($('#bathroom-pill').attr('data-state'));
                    
                    if (bathroomPillState === 0) {
                        return true; // Show all when toggle is off
                    }
                    
                    // Get room data from the DataTable's data
                    const rowData = rt.row(dataIndex).data();
                    if (!rowData) return true; // Safety check
                    
                    const hasBathroom = rowData.bathroom && rowData.bathroom.trim().toLowerCase() === 'private';
                    
                    // State 1: Positive (show only rooms WITH bathroom)
                    // State 2: Negative (show only rooms WITHOUT bathroom)
                    return (bathroomPillState === 1) ? hasBathroom : !hasBathroom;
                } catch (e) {
                    console.error("Error in bathroom filter:", e);
                    return true; // In case of error, show the row
                }
            }
        );
        
        // Add favorites filter
        if ($('#favorites-pill').hasClass('active')) {
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    try {
                        // Only apply to rooms-table
                        if (settings.nTable.id !== 'rooms-table') {
                            return true;
                        }
                        
                        const rowData = rt.row(dataIndex).data();
                        if (!rowData) return true; // Safety check
                        
                        return rowData.favorite === true;
                    } catch (e) {
                        console.error("Error in favorites filter:", e);
                        return true; // In case of error, show the row
                    }
                }
            );
        }
        
        // Add a client-side filter for college if a value is selected
        if (selectedCollege) {
            console.log("Adding client-side filter for college:", selectedCollege);
            $.fn.dataTable.ext.search.push(
                function(settings, data, dataIndex) {
                    try {
                        if (settings.nTable.id !== 'rooms-table') {
                            return true;
                        }
                        
                        const rowData = rt.row(dataIndex).data();
                        if (!rowData) return true;
                        
                        // Check if the room's college matches the selected college
                        const roomCollege = rowData.res_college || '';
                        
                        // Handle special case for "Upperclass"
                        if (selectedCollege === "Upperclass") {
                            return roomCollege.toLowerCase().includes("upperclass");
                        }
                        
                        return roomCollege === selectedCollege;
                    } catch (e) {
                        console.error("Error in college filter:", e);
                        return true;
                    }
                }
            );
        }
        
        // Redraw table with filters applied
        if (rt) {
            try {
                rt.draw();
                
                // Update UI to show how many rooms are visible
                const visibleRows = rt.rows({filter: 'applied'}).count();
                const totalRows = rt.rows().count();
                
                // Show a small toast notification with filter results
                if (visibleRows < totalRows) {
                    // Create or update the filter count notification
                    if ($('#filter-count-toast').length === 0) {
                        $('<div id="filter-count-toast" class="position-fixed" style="bottom: 20px; right: 20px; z-index: 1050; opacity: 0.9; padding: 8px 12px; border-radius: 6px; background-color: #474bc9; color: white; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>')
                            .appendTo('body');
                    }
                    
                    $('#filter-count-toast').text(`Showing ${visibleRows} of ${totalRows} rooms`)
                        .fadeIn(200)
                        .delay(3000)
                        .fadeOut(500);
                }
                
                // Debug - check which filters are applied
                console.log("Active filters:", $.fn.dataTable.ext.search.length - 1);
                console.log("Total rows:", totalRows, "Visible rows:", visibleRows);
                
            } catch (e) {
                console.error("Error redrawing table:", e);
            }
        }
    }

    // Add the custom search function after the table is initialized
    function addCustomSearchFunction() {
        // Remove any existing search functions first
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }
        
        // Add our custom search function
        $.fn.dataTable.ext.search.push(
          function(settings, searchData, index, rowData, counter) {
            // Only apply to rooms-table
            if (settings.nTable.id !== 'rooms-table') {
              return true;
            }
            
            const searchValue = $('#search').val().toLowerCase().trim();
            if (!searchValue) {
              return true; // Show all when no search text
            }
            
            // Safety check
            if (!rowData) return true;
            
            // Check building, college, and room number for matches
            const building = (rowData.building || '').toLowerCase();
            const college = (rowData.res_college || '').toLowerCase();
            const roomNo = (rowData.room_no || '').toLowerCase();
            
            // Full combined search string
            const fullSearchString = building + ' ' + roomNo + ' ' + college;
            
            // Handle searching with multiple terms (split by space)
            const searchTerms = searchValue.split(/\s+/).filter(term => term.length > 0);
            
            // If all search terms are found in the combined fields, show the row
            let allTermsFound = true;
            for (let i = 0; i < searchTerms.length; i++) {
                const term = searchTerms[i];
                
                // Check if this term is found in any field
                const termFound = 
                    building.includes(term) || 
                    college.includes(term) || 
                    roomNo.includes(term) ||
                    fullSearchString.includes(term);
                
                // Special case for Forbes/Maine
                const isForbesMaine = 
                    (term.includes('forbes') && building === 'maine') ||
                    (term.includes('maine') && college.includes('forbes'));
                    
                if (!termFound && !isForbesMaine) {
                    allTermsFound = false;
                    break;
                }
            }
            
            if (allTermsFound && searchTerms.length > 0) {
                return true;
            }
            
            // Direct match check for backward compatibility
            if (building.includes(searchValue) || 
                college.includes(searchValue) || 
                roomNo.includes(searchValue) ||
                fullSearchString.includes(searchValue)) {
              return true;
            }
            
            // Handle Forbes/Maine alias
            if ((searchValue.includes('forbes') && building === 'maine') ||
                (searchValue.includes('maine') && college.includes('forbes'))) {
              return true;
            }
            
            return false;
          }
        );
    }

    // Initialize the debounced search handler
    const debouncedSearchHandler = debounce(function() {
        applyFilters();
    }, 300);

    // Wait for DOM to be fully loaded
    // Helper function to maintain and update the building-to-college mapping
    function updateBuildingToCollegeMapping() {
        // Create a fresh mapping
        window.buildingToCollegeMap = {};
        
        // Build the mapping
        for (const college in allBuildingsData) {
            if (allBuildingsData[college] && Array.isArray(allBuildingsData[college])) {
                for (const building of allBuildingsData[college]) {
                    window.buildingToCollegeMap[building] = college;
                }
            }
        }
        
        console.log("Building-to-college mapping updated with", Object.keys(window.buildingToCollegeMap).length, "buildings");
        return window.buildingToCollegeMap;
    }
    
    $(document).ready(function() {
        // Set up event handlers
        setup();
        
        // Initialize selects
        $("#buildings").val("");
        $("#year").val("");
        
        // Set default data attributes for tracking
        $('#college').attr('data-selected-value', '');
        $('#building').attr('data-selected-value', '');
        $('#occupancy').attr('data-selected-value', '');
        $('#size').attr('data-selected-value', '');
        
        // Initialize the building-to-college mapping for better performance
        setTimeout(updateBuildingToCollegeMapping, 1000);
        
        // Reinitialize occupancy options with max of 6
        $("#occupancy").empty();
        $("#occupancy").append($("<option>").val("").html("All"));
        for (var i = 1; i <= 6; i++) {
            $("#occupancy").append($("<option>").val(i).html(i));
        }
        
        // Add smooth animations for pill filters
        $('.filter-pill').hover(
            function() { $(this).css('transform', 'translateY(-2px)'); },
            function() { $(this).css('transform', 'translateY(0)'); }
        );
        
        // Make search more responsive by handling each keypress
        $('#search').off('keyup').on('keyup', function() {
            // This will trigger our custom search function that was added at the top
            console.log("Search keyup: " + $(this).val());
            if (rt) {
                rt.draw(); // Redraw the table to apply the search filter
            }
        });
        
        // Use keydown for special keys like Enter
        $('#search').on('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (rt) {
                    rt.draw(); // Apply immediately on Enter
                }
            }
        });
        
        // Clear button for search field
        if (!$('#search-clear-btn').length) {
            $('<button id="search-clear-btn" type="button" class="btn position-absolute" style="display:none; right: 175px; top: 10px; z-index: 5; color: #999;">&times;</button>')
                .insertAfter('#search')
                .on('click', function() {
                    $('#search').val('').focus();
                    $(this).hide();
                    // Use our search mechanism directly
                    if (rt) {
                        rt.draw();
                    }
                });
            
            // Show/hide clear button based on search content
            $('#search').on('input', function() {
                $('#search-clear-btn').toggle($(this).val().length > 0);
            });
        }
    });

    async function fetchWithTimeout(resource, options = {}) {
        const {timeout = 10000} = options;

        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(id);
        return response;
    }

    function incrementReviewButton() {
        let originalDigit = window.review_button.lastChild.innerText;
        let newDigit = parseInt(originalDigit) + 1;
        window.review_button.lastChild.innerText = newDigit;
    }

    let rating;
    let review;

    function getReviews(building_name, room_no, clicked_review_button) {
        $("#reviews-body").html("<div class=\"center\"><div class=\"loadingio-spinner-eclipse-sl0eruj4pj9\"><div class=\"ldio-nsjyfj8x68\"><div></div></div></div></div>");
        
        if (clicked_review_button !== null) {
            window.review_button = clicked_review_button;
        }
        
        window.curr_building_name = building_name;
        window.curr_room_no = room_no;
        
        // Ensure jQuery Confirm is available
        if (typeof $.confirm !== 'function') {
            console.log("Loading jQuery Confirm for reviews");
            
            // Load jQuery Confirm CSS if needed
            if (!$('link[href*="jquery-confirm"]').length) {
                $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">');
            }
            
            // Load jQuery Confirm JS
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js")
                .done(function() {
                    console.log("jQuery Confirm loaded successfully");
                })
                .fail(function() {
                    console.error("Failed to load jQuery Confirm");
                });
        }
        
        // Ensure Bootstrap icons are available
        if (!$('link[href*="bootstrap-icons"]').length) {
            $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">');
        }
        
        // Ensure we have a global text_max value for character counting
        if (typeof window.text_max === 'undefined') {
            window.text_max = 5000;
        }
        
        // Show loading indicator
        setTimeout(function() {
            console.log("Fetching reviews for", building_name, room_no);
            
            fetchWithTimeout('/get_reviews?' +
                '&building_name=' + building_name +
                '&room_no=' + room_no)
                .then(response => response.text())
                .then(data => {
                    $("#reviews-body").html(data);
                    
                    // Initialize character counter for the review textarea
                    setTimeout(function() {
                        // Use the global initializeCharCounter function if available
                        if (typeof initializeCharCounter === 'function') {
                            initializeCharCounter();
                            console.log("Character counter initialized after loading reviews");
                        }
                        
                        // Make sure the review form is properly set up
                        if ($('#submit-review-form').length) {
                            // Attach event handlers
                            $("#submit-review-form").off("submit").on("submit", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                            
                            // Also attach to submit button click for more reliability
                            $(".submit-button").off("click").on("click", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                        }
                    }, 300);
                })
                .catch(error => {
                    console.error("Error fetching reviews:", error);
                    $("#reviews-body").html("<div class='alert alert-danger'>Error loading reviews. Please try again.</div>");
                });
        }, 300);
    }

    function getReviewsWithError(building_name, room_no, clicked_review_button) {
        $("#reviews-body").html("<div class=\"center\"><div class=\"loadingio-spinner-eclipse-sl0eruj4pj9\"><div class=\"ldio-nsjyfj8x68\"><div></div></div></div></div>");
        
        if (clicked_review_button !== null) {
            window.review_button = clicked_review_button;
        }
        
        window.curr_building_name = building_name;
        window.curr_room_no = room_no;
        
        // Ensure jQuery Confirm is available
        if (typeof $.confirm !== 'function') {
            console.log("Loading jQuery Confirm for reviews");
            
            // Load jQuery Confirm CSS if needed
            if (!$('link[href*="jquery-confirm"]').length) {
                $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">');
            }
            
            // Load jQuery Confirm JS
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js")
                .done(function() {
                    console.log("jQuery Confirm loaded successfully");
                })
                .fail(function() {
                    console.error("Failed to load jQuery Confirm");
                });
        }
        
        // Ensure Bootstrap icons are available
        if (!$('link[href*="bootstrap-icons"]').length) {
            $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">');
        }
        
        // Ensure we have a global text_max value for character counting
        if (typeof window.text_max === 'undefined') {
            window.text_max = 5000;
        }
        
        // Show loading indicator
        setTimeout(function() {
            console.log("Fetching reviews (with error context) for", building_name, room_no);
            
            fetchWithTimeout('/get_reviews?' +
                '&building_name=' + building_name +
                '&room_no=' + room_no)
                .then(response => response.text())
                .then(data => {
                    $("#reviews-body").html(data);
                    
                    // Initialize character counter for the review textarea
                    setTimeout(function() {
                        // Use the global initializeCharCounter function if available
                        if (typeof initializeCharCounter === 'function') {
                            initializeCharCounter();
                            console.log("Character counter initialized after loading reviews");
                        }
                        
                        // Make sure the review form is properly set up
                        if ($('#submit-review-form').length) {
                            // Attach event handlers
                            $("#submit-review-form").off("submit").on("submit", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                            
                            // Also attach to submit button click for more reliability
                            $(".submit-button").off("click").on("click", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                        }
                        
                        // Display error message if applicable
                        if (window.errorMessage) {
                            if (window.notyf) {
                                window.notyf.error(window.errorMessage);
                                window.errorMessage = null;
                            }
                        }
                    }, 300);
                })
                .catch(error => {
                    console.error("Error fetching reviews:", error);
                    $("#reviews-body").html("<div class='alert alert-danger'>Error loading reviews. Please try again.</div>");
                });
        }, 300);
    }

    function submitReviewWithoutRefresh() {
        rating = $("#overall-rating").val()
        review = $("#written-review").val()
        let reviewForm = $("form#submit-review-form")[0];
        let formData = new FormData(reviewForm);
        $.ajax({
            type: 'POST',
            url: '/submitReview',
            contentType: false,
            dataType: "json",
            cache: false,
            processData: false,
            data: formData,
            success: function (data, textStatus, jqXHR) {
                $('#submit-review-form').trigger("reset");
                notyf.success(jqXHR.responseJSON.message);
                incrementReviewButton();
                getReviews(window.curr_building_name, window.curr_room_no, null);
            },
            error: function (jqXHR) {
                if (jqXHR.responseJSON.message === 'override') {
                    $.confirm({
                        title: 'You will override your old review with this new review.',
                        buttons: {
                            confirm: {
                                action: function () {
                                    $("#override").val('yes')
                                    reviewForm = $("form#submit-review-form")[0];
                                    formData = new FormData(reviewForm);
                                    $.ajax({
                                        type: 'POST',
                                        url: '/submitReview',
                                        contentType: false,
                                        dataType: "json",
                                        cache: false,
                                        processData: false,
                                        data: formData,
                                        success: function (data, textStatus, jqXHR) {
                                            $('#submit-review-form').trigger("reset");
                                            notyf.success(jqXHR.responseJSON.message);
                                            getReviews(window.curr_building_name, window.curr_room_no, null);
                                        },
                                        error: function (jqXHR) {
                                            notyf.error(jqXHR.responseJSON.message);
                                            getReviewsWithError(window.curr_building_name, window.curr_room_no, null);
                                        }
                                    });
                                },
                                btnClass: 'btn-blue',
                            },
                            cancel: {
                                action: function () {
                                },
                                btnClass: 'btn-red',
                            },
                        }
                    });
                } else {
                    notyf.error(jqXHR.responseJSON.message);
                    getReviewsWithError(window.curr_building_name, window.curr_room_no, null);
                }
            }
        })
    }

</script>
