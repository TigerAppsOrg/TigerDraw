<!DOCTYPE html>
<html>

<head>
    <title>TigerDraw</title>
    <link rel="icon" href="{{ url_for('static', filename='assets/img/finder.png') }}">
    <meta charset="utf-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">
</head>
<style>
    .rooms-table {
        font-size: 0.9em;
        min-width: 800px;
        box-shadow: 10px 10px 20px rgba(120, 132, 241, 0.15);
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        top: 50%;
        left: 50%;
        margin-right: auto;
        margin-left: auto;
    }

    .rooms-table thead tr {
        background-color: #7884F1;
        color: #FFFFFF;
        text-align: left;
        font-weight: bold;
    }

    .rooms-table th,
    .rooms-table td {
        padding: 12px 15px;
    }

    .rooms-table tbody tr {
        border-bottom: thin solid #7884F1;
    }


    .star {
        visibility: hidden;
        display: inline-block;
    }

    .star:before {
        content: "\2606";
        display: inline-block;
        visibility: visible;
        height: 20px;
        width: 20px;
        padding-bottom: 10px;
    }

    .star:checked:before {
        content: "\2605";
        display: inline-block;
        padding-bottom: 10px;
        color: #ffe135;
    }


    h2 {
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        text-align: center;
        font-weight: normal;
        font-size: 2em;
        margin-top: 20px;
    }

    .help-tip {
        position: absolute;
        top: 18px;
        right: 18px;
        text-align: center;
        background-color: #7884F1;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 26px;
        cursor: default;
        margin-top: -20px;
        z-index: 1;
    }

    .help-tip:before {
        content: '?';
        font-weight: bold;
        color: #fff;
    }

    .help-tip:hover p {
        display: block;
        transform-origin: 100% 0%;

        -webkit-animation: fadeIn 0.3s ease-in-out;
        animation: fadeIn 0.3s ease-in-out;

    }

    .help-tip p {
        /* The tooltip */
        display: none;
        text-align: left;
        background-color: #7884F1;
        padding: 10px;
        width: 300px;
        position: absolute;
        border-radius: 3px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        right: -4px;
        color: #FFF;
        font-size: 13px;
        line-height: 1.4;
    }

    .help-tip p:before {
        /* The pointer of the tooltip */
        position: absolute;
        content: '';
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-bottom-color: #7884F1;
        right: 10px;
        top: 40px;
    }

    .help-tip p:after {
        /* Prevents the tooltip from being hidden */
        width: 100%;
        height: 40px;
        content: '';
        position: absolute;
        top: 40px;
        left: 0;
    }

    /* CSS animation */

    @-webkit-keyframes fadeIn {
        0% {
            opacity: 0;
            transform: scale(0.6);
        }

        100% {
            opacity: 100%;
            transform: scale(1);
        }
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 100%;
        }
    }
</style>

<body data-username={{username}}>

{% with page='rooms' %}
{% include 'navbar.html' %}
{% endwith %}

<!-- Modal for adding groups -->
{% include 'add_room_modal.html' %}

<div style="padding:10px; background: #ef5350; text-align: center;">
    <h5 style="font-weight:500; color: white; margin: 0;">TigerDraw is independent from the previous
        Rooms app, which broke due to outdated code. Visit <a
                style="color: white; text-decoration: underline; font-weight: bold;"
                target="_blank"
                href="https://reviews.tigerapps.org/">reviews.tigerapps.org</a> to see the reviews from
        that app.</h5>
    <br>
    <h5 style="font-weight:500; color: white; margin: 0;">Room data for NCW and NCE are currently
        unavailable. Floor plans for NCW, NCE, and all other buildings can be accessed <a
                style="color: white; text-decoration: underline;"
                target="_blank"
                href="https://sp2016.princeton.edu/uservices/housing/floorplans/undergraduate/default.aspx">HERE</a>.
    </h5>
</div>

<div style="padding-top:25px;">
    <h2 style="font-weight:700;">Past Room Draws</h2>
</div>
<div class="form-inline" style="padding-left: 75px; padding-right: 75px; padding-top:25px">
    <div class="col-auto">
        <label class="college">Ranking Range</label>
        <div class="help-tip" data-placement="top">
            <p>Rankings are based on previous draw times. Ex: if a room was picked by the first draw group, it will have
                a
                ranking of 1. If a college is chosen, we reorder rankings for rooms within the college from 1-last. If a
                college is not chosen, the ranking is taken from the overall room draw.</p>
        </div>
        <input id="firstranking" class="form-control" placeholder="Start Rank" maxlength="4" data-rule-maxlength="4"
               style="width: 130px;" type="number"
               onkeydown="javascript: return event.keyCode === 8 || event.keyCode === 46 ? true : !isNaN(Number(event.key))"/>
        to
        <input id="lastranking" class="form-control" placeholder="End Rank" maxlength="4" data-rule-maxlength="4"
               style="width: 130px;" type="number"
               onkeydown="javascript: return event.keyCode === 8 || event.keyCode === 46 ? true : !isNaN(Number(event.key))"/>
    </div>
    <div class="col-auto my-1">
        <label class="college">College</label>
        <select class="form-control" name="college" id="college">
            <option value="">All</option>
            <option value="Butler College">Butler</option>
            <option value="Forbes College">Forbes</option>
            <option value="Mathey College">Mathey</option>
            <option value="No Res College Associated">No Res College Associated</option>
            <option value="Rockefeller College">Rocky</option>
            <option value="Whitman College">Whitman</option>
            <option value="Wilson College">Wilson</option>
            <option value="Upperclass">Upperclassman</option>
        </select>
    </div>
    <div class="col-auto my-1">
        <label class="building">Building</label>
        <select class="form-control" name="building" id="building">
            <option value="">All</option>
        </select>
    </div>
    <div class="col-auto my-1">
        <label class="college">Occupancy</label>
        <select class="form-control" name="occupancy" id="occupancy"></select>
    </div>
    <div class="col-auto my-1">
        <label class="year">Year</label>
        <select class="form-control" name="year" id="year">
            <option value="">Average of All Years</option>
            <option value="2019">2019</option>
            <option value="2017">2017</option>
        </select>
    </div>
</div>
</div>
</div>
</div>
<div>
    <div style="margin-top:20px; padding-left: 75px; padding-right: 75px; padding-bottom: 100px;">
        <div class="table-responsive">
            <table id="rooms-table" class="table table-striped table-bordered">
                <!--       <table id="rooms-table" class="display">
         -->
                <thead>
                <tr>
                    <th>Favorite</th>
                    <th>Ranking</th>
                    <th>College</th>
                    <th>Building</th>
                    <th>Room No.</th>
                    <th>Occupancy</th>
                    <th>Sq. Footage</th>
                    <th>Reviews</th>
                    <th>Add Room to Group</th>
                </tr>
                </thead>
                <tfoot>
                <tr>
                    <th>Favorite</th>
                    <th>Ranking</th>
                    <th>College</th>
                    <th>Building</th>
                    <th>Room No.</th>
                    <th>Occupancy</th>
                    <th>Sq. Footage</th>
                    <th>Reviews</th>
                    <th>Add Room to Group</th>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
</body>

</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- <script type="text/javascript" charset="utf8"
  src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script>

    var rt;
    var gt;
    let request = null;
    let controller = null;

    function getResults(e) {
        $.fn.dataTable.ext.errMode = 'throw';
        let college = $('#college').val();
        college = encodeURIComponent(college);
        let firstranking = $('#firstranking').val();
        firstranking = encodeURIComponent(firstranking);
        let lastranking = $('#lastranking').val();
        lastranking = encodeURIComponent(lastranking);
        let occupancy = $('#occupancy').val();
        occupancy = encodeURIComponent(occupancy);
        let year = $('#year').val();
        year = encodeURIComponent(year);
        let building = $('#building').val();
        if (e.data.change === true) {
            building = ""
            // occupancy = ""
        }
        building = encodeURIComponent(building);

        // regex to check for ints only, datavalidation
        // let isranknum = /^\d+$/.test(ranking);
        // let isoccnum = /^\d+$/.test(occupancy);
        // if (!((isranknum || ranking == "")&& (isoccnum || occupancy == ""))) {
        //   return
        // }

        let url = '/queryrooms?college=' + college + "&firstranking=" + firstranking + "&lastranking=" + lastranking + "&occupancy=" + occupancy + "&year=" + year + "&building=" + building

        if (request != null)
            request.abort();

        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function (a) {
                a = (a === "UNRANKED") ? Number.POSITIVE_INFINITY : parseFloat(a);
                return a;
            },

            "formatted-num-asc": function (a, b) {
                return a - b;
            },

            "formatted-num-desc": function (a, b) {
                return b - a;
            }
        });

        // added button
        rt = $('#rooms-table').DataTable({
            destroy: true,
            searching: false,
            columnDefs: [
                {targets: 1, type: "formatted-num"},
            ],
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            "order": [[1, "asc"]],
            "pageLength": 20,
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
            },

            "columns": [
                {
                    targets: 0,
                    className: 'text-center',
                    searchable: false,
                    orderable: false,
                    "data": "favorites",
                    render: function (data, type, full, meta) {
                        if (full.favorite === true) {
                            return '<input type="checkbox" class="star" name="star" checked="true">';
                        } else {
                            return '<input type="checkbox" class="star" name="star">';
                        }
                    },
                },
                {"data": "ranking"},
                {"data": "res_college"},
                {"data": "building"},
                {"data": "room_no"},
                {"data": "occupancy"},
                {"data": "sq_footage"},
                {
                    "targets": -1,
                    "data": null,
                    className: 'text-center',
                    "defaultContent": '<button type="button" style="background-color:#474bc9" class="btn btn-primary" data-toggle="modal" data-target="#seeReviewsModal" data-whatever="@getbootstrap">See Reviews</button>'
                },
                {
                    "targets": -1,
                    "data": null,
                    className: 'text-center',
                    "defaultContent": '<button type="button" style="background-color:#474bc9" class="btn btn-primary" data-toggle="modal" data-target="#addRoomModal" data-whatever="@getbootstrap">Add Room</button>'
                },
            ],
            "rowCallback": function (row, data, index) {
                if (data["taken"] === true) {
                    $('td', row).css('background-color', '#ffcccb');
                }
            }
        })

        if (e.data.change === true || typeof (e.data) === "function") {
            rt.ajax.url(url).load(populateDropdowns)
        } else {
            rt.ajax.url(url).load()
        }

    }

    // dynamic dropdown
    function populateDropdowns(json) {
        const buildings = []
        // update building dropdown
        $('#building').empty()
        $("#building").append($("<option>").val("").html("All"));

        json.data.forEach(function (obj) {
            if (buildings.indexOf(obj.building) == -1) {
                $("#building").append($("<option>").val(obj.building).html(obj.building));
                buildings.push(obj.building)
            }
        });
    }

    function getGroups(room_id) {
        let url = '/populategroups?room_id=' + encodeURIComponent(room_id);

        if (request != null)
            request.abort();

        // added button
        gt = $('#groups-table').DataTable({
            "oLanguage": {
                "sEmptyTable": "You are not part of any groups. You may create a group on the Groups page."
            },
            destroy: true,
            searching: false,
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            // "order": [[1, "asc"]],
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
                "url": url,
            },
            "columns": [
                {
                    "data": "name",
                    "title": "Group Name"
                },
                {
                    targets: 0,
                    className: 'text-center',
                    searchable: false,
                    orderable: false,
                    "data": "favorited",
                    "title": "In group?",
                    render: function (data, type, full, meta) {
                        if (full.favorited === true) {
                            return '<input type="checkbox" class="checkbox" name="star" checked="true">';
                        } else {
                            return '<input type="checkbox" class="checkbox" name="star">';
                        }
                    },
                },
            ],
        });

        // if (e.data.change === true || typeof (e.data) === "function") {
        //   gt.ajax.url(url).load(populateDropdowns)
        // }
        // else {
        gt.ajax.url(url).load()
        // }

    }

    function setup() {

        $('#college').on('change', {change: true}, getResults)
        $('#firstranking').on('input', {}, getResults)
        $('#lastranking').on('input', {}, getResults)
        $('#occupancy').on('change', {}, getResults)
        $('#year').on('change', {}, getResults)
        $('#building').on('change', {}, getResults)

        // on clicking stars, either favorite or unfavorite
        $('#rooms-table').on('change', '.star', function () {
            var data = rt.row($(this).parents('tr')).data();
            changing_row = rt.row(this.closest('tr')).data()

            if (this.checked !== true) {
                // send message to db to remove from favorites
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeFromFravorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            } else {
                // SEND MESSAGE TO DATABASE TO ADD TO FAVORITES
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addToFavorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            }
        });

        // set up listener for button to add room to group list
        $('#rooms-table').on('click', 'button', function () {
            // get favorites and set up table
            var data = rt.row($(this).parents('tr')).data();
            $("#addRoomModal").attr('data-room-id', data['room_id']);
            getGroups(data['room_id']);

            var data_arr = Object.values(data);
        });

        // on clicking stars, add room to specified group
        $('#groups-table').on('change', '.checkbox', function () {
            var data = gt.row($(this).parents('tr')).data();
            var room_id = $("#addRoomModal").attr('data-room-id');

            var username = $('body').data('username');
            // console.log(username);
            room_and_group = {"room_id": room_id, "group_id": data['group_id'], "username": username};
            if (this.checked !== true) {
                // send message to db to remove room from group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeroomfromgroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            } else {

                // send message to db to add room to group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addroomtogroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            }

        });

    }

    $('document').ready(getResults)
    $('document').ready(setup)
    $("#buildings").val("");
    $("#year").val("");

    $("#occupancy").append($("<option>").val("").html("All"));
    for (var i = 1; i < 11; i++) {
        $("#occupancy").append($("<option>").val(i).html(i));
    }

</script>