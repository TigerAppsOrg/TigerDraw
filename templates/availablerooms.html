<!DOCTYPE html>
<html>

<head>
    <title>TigerDraw</title>
    <link rel="icon" href="{{ url_for('static', filename='assets/img/finder.png') }}">
    <meta charset="utf-8">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/main.css') }}">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css">

    <!-- Link jQuery Confirm -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

    <!-- Link Notyf CSS Library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
    <!-- Link Notyf JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2P8PYDHQZ7"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-2P8PYDHQZ7');
    </script>

</head>
<style>
    .btn-primary {
        border-color: #474bc9 !important;
    }

    .page-item.active .page-link {
        z-index: 1;
        color: #fff !important;
        background-color: #474bc9 !important;
        border-color: #474bc9 !important;
    }

    .page-link {
        position: relative;
        display: block;
        padding: 0.5rem 0.75rem;
        margin-left: -1px;
        line-height: 1.25;
        color: #474bc9 !important;
        background-color: #fff;
        border: 1px solid #dee2e6;
    }

    /* Custom styles for the search bar */
    .search-bar-wrapper {
        transition: all 0.3s ease;
    }

    .search-bar-wrapper:focus-within {
        box-shadow: 0 0 0 0.2rem rgba(120, 132, 241, 0.25);
    }

    #search-specifics-btn {
        transition: all 0.3s ease;
    }

    #search-specifics-btn:hover {
        background-color: #e9ecef !important;
    }

    .search-filters {
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Custom toggle switch styling */
    .custom-switch .custom-control-label::before {
        width: 36px;
        height: 20px;
        border-radius: 10px;
        background-color: #ccc;
        border: none;
    }

    .custom-switch .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #7884F1;
        border-color: #7884F1;
    }

    .custom-switch .custom-control-label::after {
        top: calc(0.25rem + 1px);
        left: calc(-2.25rem + 2px);
        width: 18px;
        height: 18px;
        background-color: #fff;
        border-radius: 50%;
        transition: transform 0.15s ease-in-out, background-color 0.15s ease-in-out;
    }

    .custom-switch .custom-control-input:checked ~ .custom-control-label::after {
        transform: translateX(1rem);
    }

    .amenity-icon svg {
        fill: #7884F1;
    }

    /* Fan icon for AC */
    .fan-icon {
        color: #7884F1;
        font-size: 1.2rem;
    }

    /* Bathroom icon */
    .bathroom-icon {
        color: #7884F1;
        font-size: 1.2rem;
    }

    .rooms-table {
        font-size: 0.9em;
        min-width: 800px;
        box-shadow: 10px 10px 20px rgba(120, 132, 241, 0.15);
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        top: 50%;
        left: 50%;
        margin-right: auto;
        margin-left: auto;
    }

    .rooms-table thead tr {
        background-color: #7884F1;
        color: #FFFFFF;
        text-align: left;
        font-weight: bold;
    }

    .rooms-table th,
    .rooms-table td {
        padding: 12px 15px;
    }

    td {
        vertical-align: middle !important;
    }

    .rooms-table tbody tr {
        border-bottom: thin solid #7884F1;
    }


    .star {
        visibility: hidden;
        display: inline-block;
    }

    .star:before {
        content: "\2661";
        display: inline-block;
        visibility: visible;
        height: 20px;
        width: 20px;
        padding-bottom: 10px;
    }

    .star:checked:before {
        content: "\2665";
        display: inline-block;
        padding-bottom: 10px;
        color: #F15156;
    }

    textarea {
        resize: none;
    }

    #count_message {
        background-color: #474bc9 !important;
        color: white !important;
        margin-top: -20px;
        margin-right: 5px;
    }

    h2 {
        font-family: helveticaneue-light, helvetica neue light, helvetica neue, Helvetica, Arial, lucida grande, sans-serif;
        text-align: center;
        font-weight: normal;
        font-size: 2em;
        margin-top: 20px;
    }

    .help-tip {
        position: absolute;
        top: 18px;
        right: 18px;
        text-align: center;
        background-color: #7884F1;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        line-height: 26px;
        cursor: default;
        margin-top: -20px;
        z-index: 1;
    }

    .help-tip:before {
        content: '?';
        font-weight: bold;
        color: #fff;
    }

    .help-tip:hover p {
        display: block;
        transform-origin: 100% 0%;

        -webkit-animation: fadeIn 0.3s ease-in-out;
        animation: fadeIn 0.3s ease-in-out;

    }

    .help-tip p {
        /* The tooltip */
        display: none;
        text-align: left;
        background-color: #7884F1;
        padding: 10px;
        width: 300px;
        position: absolute;
        border-radius: 3px;
        box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
        right: -4px;
        color: #FFF;
        font-size: 13px;
        line-height: 1.4;
    }

    .help-tip p:before {
        /* The pointer of the tooltip */
        position: absolute;
        content: '';
        width: 0;
        height: 0;
        border: 6px solid transparent;
        border-bottom-color: #7884F1;
        right: 10px;
        top: 40px;
    }

    .help-tip p:after {
        /* Prevents the tooltip from being hidden */
        width: 100%;
        height: 40px;
        content: '';
        position: absolute;
        top: 40px;
        left: 0;
    }


    .announcement-banner {
        width: 100%;
        position: relative; 
        margin-bottom: 0; 
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .alert-info {
        background-color: #e2efff;
        color: #0c5460;
        border: none;
    }

    .alert-info .alert-link {
        color: #074a5a;
        font-weight: bold;
        text-decoration: underline;
    }

    #rooms-table_filter {
        display: none;
    }

    /* CSS animation */

    @-webkit-keyframes fadeIn {
        0% {
            opacity: 0;
            transform: scale(0.6);
        }

        100% {
            opacity: 100%;
            transform: scale(1);
        }
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
        }

        100% {
            opacity: 100%;
        }
    }
</style>

<body data-username={{ username }}>

{% with page='rooms' %}
{% include 'navbar.html' %}
{% endwith %}

<!-- Modal for adding groups -->
{% include 'add_room_modal.html' %}

{% include 'see_reviews_modal.html' %}

{% include 'updates_modal.html' %}


<!--{#-->
<!--<div style="padding:10px; background: #474bc9; text-align: center;">#}-->
<!--       <h5 style="font-weight:500; color: white; margin: 0;">Visit <a
            style="color: white; text-decoration: underline; font-weight: bold;"
            target="_blank"
            href="https://rooms.tigerapps.org/">rooms.tigerapps.org</a> to view room reviews and
          search/sort through the 2022-2023 rooms list!</h5>
      <br>
      <h5 style="font-weight:500; color: white; margin: 0;">Floor plans for NCW, NCE, and all other
          buildings can be accessed <a style="color: white; text-decoration: underline;"
            target="_blank"
            href="https://sp2016.princeton.edu/uservices/housing/floorplans/undergraduate/default.aspx">HERE</a>.
      </h5>
      <br> -->
<!--    {# <h3 style=" font-weight:500; color: white; margin-bottom: 0px">Due to high amount of user traffic, you may have-->
<!--        to#}-->
<!--        {# wait at most 3 minutes for the site to fully load.</h3>#}-->


<!--    {#-->
<!--</div>-->
<!--#}-->

<!-- <div style="padding:10px; background: #474bc9; text-align: center;">
    <h3 style=" font-weight:500; color: white; margin-bottom: 0px">Due to high amount of user traffic, you may have to wait at most 3 minutes for the site to fully load.</h3>
</div> -->


<div class="container" style="margin-top: 25px;">
    <div class="row">
        <div class="col text-center">
            <button class="btn btn-primary" style="background: #474bc9;font-weight: bold" data-toggle="modal"
                    data-target="#updatesModal">View TigerDraw Updates
            </button>
        </div>
    </div>
</div>

<div style="padding-top:25px;">
    <h2 style="font-weight:700;">Rooms</h2>
    <p class="text-center mx-2">Browse <b>{{ total_reviews }}</b> reviews (and counting!) across <b>{{ total_rooms }}</b> rooms.</p>
    <p class="text-center mx-2">Select a Residential College to get started. Please find your room and <b>leave an honest review</b> for future inhabitants!</p>
    <!-- <p class="text-center mx-2 font-italic">Note: Data comes from the 2017 and 2019 draws. Check the official rooms list for up-to-date information.</p> -->
    <div class="announcement-banner alert alert-info text-center mb-0" role="alert">
        <strong>Do you have a room draw PDF?</strong>
        <a href="https://rooms.tigerapps.org/" class="alert-link" target="_blank" rel="noopener noreferrer">Upload it here</a>
        to see what rooms are still available.
      </div>
</div>

<!-- New Search Bar Implementation -->
<div class="container mt-4">
    <div class="search-container" style="max-width: 800px; margin: 0 auto;">
        <div class="search-bar-wrapper d-flex" style="border: 1px solid #ccc; border-radius: 5px; overflow: hidden;">
            <input type="text" id="search" class="form-control border-0" placeholder="Search for a room!" style="flex-grow: 1; box-shadow: none;">
            <button id="search-specifics-btn" class="btn text-secondary" style="background: #f8f9fa; border-left: 1px solid #ccc; padding: 0.5rem 1rem; white-space: nowrap;">
                Search by specifics
            </button>
        </div>
        
        <!-- Expandable filters section -->
        <div id="search-filters" class="search-filters mt-3 px-3 py-3" style="display: none; border: 1px solid #ccc; border-radius: 5px; background: #f8f9fa;">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <label class="d-block">College</label>
                    <select class="form-control" name="college" id="college">
                        <option disabled selected value></option>
                        <option value="Butler College">Butler</option>
                        <option value="Forbes College">Forbes</option>
                        <option value="Mathey College">Mathey</option>
                        <option value="New College West">New College West</option>
                        <option value="No Res College Associated">No Res College Associated</option>
                        <option value="Rockefeller College">Rocky</option>
                        <option value="Whitman College">Whitman</option>
                        <option value="Upperclass">Upperclassman</option>
                        <option value="Yeh College">Yeh</option>
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label class="d-block">Building</label>
                    <select class="form-control" name="building" id="building">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col-md-3 mb-2">
                    <label class="d-block">Occupancy</label>
                    <select class="form-control" name="occupancy" id="occupancy"></select>
                </div>
                <div class="col-md-3 mb-2">
                    <label class="d-block">Size</label>
                    <select class="form-control" name="size" id="size">
                        <option value="">All</option>
                        <option value="small">Small (&lt;300 sq ft)</option>
                        <option value="medium">Medium (300-450 sq ft)</option>
                        <option value="large">Large (&gt;450 sq ft)</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6 mb-2">
                    <label class="d-block">Amenities</label>
                    <div class="d-flex align-items-center">
                        <div class="toggle-wrapper mr-4">
                            <div class="d-flex align-items-center">
                                <div class="amenity-icon mr-2">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2C13.8565 2 15.637 2.7375 16.9497 4.05025C18.2625 5.36301 19 7.14348 19 9C19 11.6727 13.8636 13.9091 13.8636 17.1818H10.1364C10.1364 13.9091 5 11.6727 5 9C5 7.14348 5.7375 5.36301 7.05025 4.05025C8.36301 2.7375 10.1435 2 12 2ZM7.36364 9C7.36364 9.86195 8.10455 10.7299 9.20564 11.472C9.81965 11.8779 10.4881 12.2273 11.1932 12.5136C11.1159 12.01 11.0455 11.5205 11.0455 11C11.0455 9.29162 11.7316 7.65302 12.9548 6.42982C14.178 5.20661 15.8166 4.52045 17.525 4.52045L17.6727 4.52045C16.8816 3.7875 15.8926 3.33355 14.8416 3.22284C13.7906 3.11212 12.7336 3.35073 11.8273 3.90144C10.921 4.45215 10.2162 5.28772 9.81323 6.2883C9.41029 7.28888 9.33206 8.39856 9.59091 9.45455C9.33355 9.37009 9.07842 9.27682 8.82727 9.17636C8.14364 8.86818 7.5 8.45 7.36364 9ZM11.0455 19.5455H12.9545V22H11.0455V19.5455Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="mr-2">A/C</span>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="ac-toggle">
                                    <label class="custom-control-label" for="ac-toggle"></label>
                                </div>
                            </div>
                        </div>
                        <div class="toggle-wrapper">
                            <div class="d-flex align-items-center">
                                <div class="amenity-icon mr-2">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M17.5,21H6.5C5.84,21 5.28,20.64 5.03,20.12L3.84,17.16C3.66,16.75 3.8,16.28 4.16,16.04C4.32,15.94 4.5,15.89 4.68,15.89C4.95,15.89 5.2,16 5.34,16.23L5.57,16.57C5.79,16.91 6.16,17.11 6.54,17.11H17.45C17.84,17.11 18.2,16.91 18.42,16.57L18.65,16.23C18.79,16 19.05,15.89 19.31,15.89C19.5,15.89 19.67,15.94 19.83,16.04C20.2,16.28 20.33,16.75 20.15,17.16L18.96,20.12C18.72,20.64 18.16,21 17.5,21Z" fill="currentColor"/>
                                        <path d="M16,11H15V10H13V11H11V10H9V11H8C7.45,11 7,10.55 7,10V5C7,4.45 7.45,4 8,4H16C16.55,4 17,4.45 17,5V10C17,10.55 16.55,11 16,11Z" fill="currentColor"/>
                                        <path d="M12,16C10.9,16 10,15.1 10,14H14C14,15.1 13.1,16 12,16Z" fill="currentColor"/>
                                    </svg>
                                </div>
                                <span class="mr-2">Private Bathroom</span>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="bathroom-toggle">
                                    <label class="custom-control-label" for="bathroom-toggle"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div style="margin-top:20px; padding-left: 75px; padding-right: 75px; padding-bottom: 100px;">
    <div class="table-responsive">
        <table id="rooms-table" class="table table-striped table-bordered">
            <!--       <table id="rooms-table" class="display">
         -->
            <thead>
            <tr>
                <th>Favorite</th>
                <th>College</th>
                <th>Building</th>
                <th>Room No.</th>
                <th>Occupancy</th>
                <th>Sq. Footage</th>
                <th style="min-width: 84px;">Rating</th>
                <th>Elevator</th>
                <th>Bathroom</th>
                <th>AC</th>
                <th>Floor</th>
                <th>Wawa</th>
                <th>UStore</th>
                <th>Nassau St</th>
                <th>Jadwin Gym</th>
                <th>Frist</th>
                <th>Street</th>
                <th>Eng Quad</th>
                <th>Dillon</th>
                <th>Reviews</th>
                <th>Add Room to Group</th>
            </tr>
            </thead>
            <tfoot>
            <tr>
                <th>Favorite</th>
                <th>College</th>
                <th>Building</th>
                <th>Room No.</th>
                <th>Occupancy</th>
                <th>Sq. Footage</th>
                <th style="min-width: 84px;">Rating</th>
                <th>Elevator</th>
                <th>Bathroom</th>
                <th>AC</th>
                <th>Floor</th>
                <th>Wawa</th>
                <th>UStore</th>
                <th>Nassau St</th>
                <th>Jadwin Gym</th>
                <th>Frist</th>
                <th>Street</th>
                <th>Eng Quad</th>
                <th>Dillon</th>
                <th>Reviews</th>
                <th>Add Room to Group</th>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
</body>

</html>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- <script type="text/javascript" charset="utf8"
  src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script>
    // Initialize Notyf globally for notifications throughout the page
    const notyf = new Notyf({
        duration: 5000,
        position: {
            x: 'right',
            y: 'top',
        },
        types: [
            {
                type: 'success',
                backgroundColor: '#4e73df',
                icon: false
            },
            {
                type: 'error',
                backgroundColor: '#dc3545',
                icon: false
            }
        ]
    });
    
    // Ensure the Notyf instance is available globally
    window.notyf = notyf;
    
    let text_max;
    var rt;
    var gt;
    let request = null;
    let controller = null;

    // Custom search extension for DataTables to handle Forbes/Maine alias
    $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {
        // Only apply to rooms-table
        if (settings.nTable.id !== 'rooms-table') {
          return true;
        }
        
        const searchValue = $('#search').val().toLowerCase();
        if (!searchValue) {
          return true; // Show all when no search text
        }
        
        // Building is in the 3rd column (index 2)
        const building = data[2].toLowerCase();
        // College is in the 2nd column (index 1)
        const college = data[1].toLowerCase();
        // Room number is in the 4th column (index 3)
        const roomNo = data[3].toLowerCase();
        
        // Direct match check
        if (building.includes(searchValue) || 
            college.includes(searchValue) || 
            roomNo.includes(searchValue) ||
            (building + ' ' + roomNo).includes(searchValue)) {
          return true;
        }
        
        // Handle Forbes/Maine alias
        if ((searchValue.includes('forbes') && building === 'maine') ||
            (searchValue.includes('maine') && college.includes('forbes'))) {
          return true;
        }
        
        // Handle partial matches for building names (for better UX)
        if (searchValue.length >= 3) {
          const buildingWords = building.split(' ');
          const searchWords = searchValue.split(' ');
          
          for (let i = 0; i < searchWords.length; i++) {
            const searchWord = searchWords[i];
            if (searchWord.length >= 3) {
              for (let j = 0; j < buildingWords.length; j++) {
                if (buildingWords[j].includes(searchWord) || searchWord.includes(buildingWords[j])) {
                  return true;
                }
              }
            }
          }
        }
        
        return false;
      }
    );

    function getResults(e) {
        $.fn.dataTable.ext.errMode = 'throw';
        let college = $('#college').val();
        college = encodeURIComponent(college);
        let occupancy = $('#occupancy').val();
        occupancy = encodeURIComponent(occupancy);
        let year = $('#year').val();
        year = encodeURIComponent(year);
        let building = $('#building').val();
        if (e.data.change === true) {
            building = ""
            // occupancy = ""
        }
        building = encodeURIComponent(building);

        let url = '/queryrooms?college=' + college + "&occupancy=" + occupancy + "&year=" + year + "&building=" + building

        if (request != null)
            request.abort();

        jQuery.extend(jQuery.fn.dataTableExt.oSort, {
            "formatted-num-pre": function (a) {
                a = (a === "UNRANKED") ? Number.POSITIVE_INFINITY : parseFloat(a);
                return a;
            },

            "formatted-num-asc": function (a, b) {
                return a - b;
            },

            "formatted-num-desc": function (a, b) {
                return b - a;
            }
        });

        // added button
        rt = $('#rooms-table').DataTable({
            destroy: true,
            searching: true,
            columnDefs: [
                {targets: 1, type: "formatted-num"},
            ],
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            "order": [[1, "asc"]],
            "pageLength": 20,
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
            },
            "columns": [
                {
                    targets: 0,
                    className: 'text-center',
                    searchable: false,
                    orderable: false,
                    "data": "favorites",
                    render: function (data, type, full, meta) {
                        if (full.favorite === true) {
                            return '<input type="checkbox" class="star" name="star" checked="true">';
                        } else {
                            return '<input type="checkbox" class="star" name="star">';
                        }
                    },
                },
                {"data": "res_college"},
                {"data": "building"},
                {"data": "room_no"},
                {"data": "occupancy"},
                {"data": "sq_footage"},
                {
                    data: null, targets: -1, render: function (data, type, row) {
                        const full_stars = Math.floor(data.average_rating)
                        const has_half_star = (data.average_rating - full_stars) >= 0.5
                        let empty_stars = 5 - full_stars
                        if (has_half_star) {
                            empty_stars--
                        }
                        let html = ""
                        for (let i = 0; i < full_stars; i++) {
                            html += '<i class="bi bi-star-fill text-warning"></i>'
                        }
                        if (has_half_star) {
                            html += '<i class="bi bi-star-half text-warning"></i>'
                        }
                        if (empty_stars == 5) {
                            return html
                        }
                        for (let i = 0; i < empty_stars; i++) {
                            html += '<i class="bi bi-star text-warning"></i>'
                        }
                        return html
                    }
                },
                {"data": "elevator"},
                {"data": "bathroom"},
                {"data": "ac"},
                {"data": "floor"},
                {"data": "wawa"},
                {"data": "ustore"},
                {"data": "Nassau Street"},
                {"data": "Jadwin Gym"},
                {"data": "frist"},
                {"data": "street"},
                {"data": "equad"},
                {"data": "dillon"},
                {
                    data: null, targets: -1, render: function (data, type, row) {
                        return '<button type="button" style="background-color:#474bc9" class="btn btn-primary" data-toggle="modal" data-target="#seeReviewsModal" data-whatever="@getbootstrap" onclick="getReviews( \'' + data.building + '\', \'' + data.room_no + '\', this)">' + "Reviews  " + '<span class="badge badge-light" style="color: #474bc9; margin-left: 3px;">' + data.number_of_reviews + '</span></button>'
                    }
                },
                // {
                //     "targets": -1,
                //     "data": null,
                //     className: 'text-center',
                //     "defaultContent": '<button type="button" style="background-color:#474bc9" class="btn btn-primary" data-toggle="modal" data-target="#seeReviewsModal" data-whatever="@getbootstrap" onclick="getReviews()">See Reviews</button>'
                // },
                {
                    "targets": -1,
                    "data": null,
                    className: 'text-center',
                    "defaultContent": '<button type="button" style="background-color:#474bc9" class="btn btn-primary" data-toggle="modal" data-target="#addRoomModal" data-whatever="@getbootstrap">Add Room</button>'
                },
            ],
        })

        if (e.data.change === true || typeof (e.data) === "function") {
            rt.ajax.url(url).load(populateDropdowns)
        } else {
            rt.ajax.url(url).load()
        }

    }

    // dynamic dropdown
    function populateDropdowns(json) {
        const buildings = []
        // update building dropdown
        $('#building').empty()
        $("#building").append($("<option>").val("").html("All"));

        json.data.forEach(function (obj) {
            if (buildings.indexOf(obj.building) == -1) {
                $("#building").append($("<option>").val(obj.building).html(obj.building));
                buildings.push(obj.building)
            }
        });
    }

    function getGroups(room_id) {
        let url = '/populategroups?room_id=' + encodeURIComponent(room_id);

        if (request != null)
            request.abort();

        // added button
        gt = $('#groups-table').DataTable({
            "oLanguage": {
                "sEmptyTable": "You are not part of any groups. You may create a group on the Groups page."
            },
            destroy: true,
            searching: false,
            "pagingType": "first_last_numbers",
            "bLengthChange": false,
            // "order": [[1, "asc"]],
            "processing": true,
            "ajax": {
                "type": "GET",
                "dataType": "json",
                "dataSrc": "data",
                "url": url,
            },
            "columns": [
                {
                    "data": "name",
                    "title": "Group Name"
                },
                {
                    targets: 0,
                    className: 'text-center',
                    searchable: false,
                    orderable: false,
                    "data": "favorited",
                    "title": "In group?",
                    render: function (data, type, full, meta) {
                        if (full.favorited === true) {
                            return '<input type="checkbox" class="checkbox" name="star" checked="true">';
                        } else {
                            return '<input type="checkbox" class="checkbox" name="star">';
                        }
                    },
                },
            ],
        });

        // if (e.data.change === true || typeof (e.data) === "function") {
        //   gt.ajax.url(url).load(populateDropdowns)
        // }
        // else {
        gt.ajax.url(url).load()
        // }

    }

    function setup() {
        $('#college').on('change', {change: true}, getResults)
        $('#occupancy').on('change', {}, getResults)
        $('#year').on('change', {}, getResults)
        $('#building').on('change', {}, getResults)

        // Add change handlers for new filters
        $('#size').on('change', function() {
            // Apply size filter when changed
            applyFilters();
        });

        $('#ac-toggle').on('change', function() {
            // Apply AC filter when toggled
            applyFilters();
        });

        $('#bathroom-toggle').on('change', function() {
            // Apply bathroom filter when toggled
            applyFilters();
        });

        // Search specifics button toggle functionality
        $('#search-specifics-btn').on('click', function() {
            $('#search-filters').slideToggle(300);
            
            // Change button text based on current state
            if ($('#search-filters').is(':visible')) {
                $(this).text('Hide filters');
            } else {
                $(this).text('Search by specifics');
            }
        });

        // Remove the old search handler that was causing conflicts
        $('#search').off('keyup');
        
        // Add the improved search handler
        $('#search').on('keyup', function() {
            // This will now be handled by our custom search function
            rt.draw();
            console.log("Applying custom search filter:", this.value);
        });

        // on clicking stars, either favorite or unfavorite
        $('#rooms-table').on('change', '.star', function () {
            var data = rt.row($(this).parents('tr')).data();
            changing_row = rt.row(this.closest('tr')).data()

            if (this.checked !== true) {
                // send message to db to remove from favorites
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeFromFravorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            } else {
                // SEND MESSAGE TO DATABASE TO ADD TO FAVORITES
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addToFavorites')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(changing_row.room_id)
                });
            }
        });

        // set up listener for button to add room to group list
        $('#rooms-table').on('click', 'button', function () {
            // get favorites and set up table
            var data = rt.row($(this).parents('tr')).data();
            $("#addRoomModal").attr('data-room-id', data['room_id']);
            getGroups(data['room_id']);

            var data_arr = Object.values(data);
        });

        // on clicking stars, add room to specified group
        $('#groups-table').on('change', '.checkbox', function () {
            var data = gt.row($(this).parents('tr')).data();
            var room_id = $("#addRoomModal").attr('data-room-id');

            var username = $('body').data('username');
            // console.log(username);
            room_and_group = {"room_id": room_id, "group_id": data['group_id'], "username": username};
            if (this.checked !== true) {
                // send message to db to remove room from group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('removeroomfromgroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            } else {

                // send message to db to add room to group
                $.ajax({
                    type: 'POST',
                    url: "{{url_for('addroomtogroup')}}",
                    contentType: 'application/json;charset=UTF-8',
                    data: JSON.stringify(room_and_group)
                });
            }

        });

    }

    function applyFilters() {
        // Create size filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                // Only apply to rooms-table
                if (settings.nTable.id !== 'rooms-table') {
                    return true;
                }
                
                const sizeValue = $('#size').val();
                if (!sizeValue) {
                    return true; // Show all when no size filter
                }
                
                // Sq Footage is in the 6th column (index 5)
                const footage = parseInt(data[5]);
                
                if (isNaN(footage)) {
                    return true; // If we can't parse the footage, just show it
                }
                
                if (sizeValue === 'small' && footage < 300) {
                    return true;
                } else if (sizeValue === 'medium' && footage >= 300 && footage <= 450) {
                    return true;
                } else if (sizeValue === 'large' && footage > 450) {
                    return true;
                }
                
                return false;
            }
        );
        
        // Create AC filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                // Only apply to rooms-table
                if (settings.nTable.id !== 'rooms-table') {
                    return true;
                }
                
                const acToggled = $('#ac-toggle').is(':checked');
                if (!acToggled) {
                    return true; // Show all when toggle is off
                }
                
                // AC is in the 10th column (index 9)
                const hasAC = data[9].trim().toLowerCase() === 'yes';
                
                return hasAC;
            }
        );
        
        // Create bathroom filter
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                // Only apply to rooms-table
                if (settings.nTable.id !== 'rooms-table') {
                    return true;
                }
                
                const bathroomToggled = $('#bathroom-toggle').is(':checked');
                if (!bathroomToggled) {
                    return true; // Show all when toggle is off
                }
                
                // Bathroom is in the 9th column (index 8)
                const hasBathroom = data[8].trim().toLowerCase() === 'private';
                
                return hasBathroom;
            }
        );
        
        // Redraw table with filters applied
        if (rt) {
            rt.draw();
        }
    }

    $('document').ready(getResults)
    $('document').ready(setup)
    $("#buildings").val("");
    $("#year").val("");

    $("#occupancy").append($("<option>").val("").html("All"));
    for (var i = 1; i < 11; i++) {
        $("#occupancy").append($("<option>").val(i).html(i));
    }

    async function fetchWithTimeout(resource, options = {}) {
        const {timeout = 10000} = options;

        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const response = await fetch(resource, {
            ...options,
            signal: controller.signal
        });
        clearTimeout(id);
        return response;
    }

    function incrementReviewButton() {
        let originalDigit = window.review_button.lastChild.innerText;
        let newDigit = parseInt(originalDigit) + 1;
        window.review_button.lastChild.innerText = newDigit;
    }

    let rating;
    let review;

    function getReviews(building_name, room_no, clicked_review_button) {
        $("#reviews-body").html("<div class=\"center\"><div class=\"loadingio-spinner-eclipse-sl0eruj4pj9\"><div class=\"ldio-nsjyfj8x68\"><div></div></div></div></div>");
        
        if (clicked_review_button !== null) {
            window.review_button = clicked_review_button;
        }
        
        window.curr_building_name = building_name;
        window.curr_room_no = room_no;
        
        // Make sure body has the rooms-page class for CSS targeting
        $('body').addClass('rooms-page');
        
        // Ensure jQuery Confirm is available
        if (typeof $.confirm !== 'function') {
            console.log("Loading jQuery Confirm for reviews");
            
            // Load jQuery Confirm CSS if needed
            if (!$('link[href*="jquery-confirm"]').length) {
                $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">');
            }
            
            // Load jQuery Confirm JS
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js")
                .done(function() {
                    console.log("jQuery Confirm loaded successfully");
                })
                .fail(function() {
                    console.error("Failed to load jQuery Confirm");
                });
        }
        
        // Ensure Bootstrap icons are available
        if (!$('link[href*="bootstrap-icons"]').length) {
            $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">');
        }
        
        // Ensure we have a global text_max value for character counting
        if (typeof window.text_max === 'undefined') {
            window.text_max = 5000;
        }
        
        // Show loading indicator
        setTimeout(function() {
            console.log("Fetching reviews for", building_name, room_no);
            
            fetchWithTimeout('/get_reviews?' +
                '&building_name=' + building_name +
                '&room_no=' + room_no)
                .then(response => response.text())
                .then(data => {
                    $("#reviews-body").html(data);
                    
                    // Initialize character counter for the review textarea
                    setTimeout(function() {
                        // Use the global initializeCharCounter function if available
                        if (typeof initializeCharCounter === 'function') {
                            initializeCharCounter();
                            console.log("Character counter initialized after loading reviews");
                        }
                        
                        // Make sure the review form is properly set up
                        if ($('#submit-review-form').length) {
                            // Attach event handlers
                            $("#submit-review-form").off("submit").on("submit", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                            
                            // Also attach to submit button click for more reliability
                            $(".submit-button").off("click").on("click", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                        }
                    }, 300);
                })
                .catch(error => {
                    console.error("Error fetching reviews:", error);
                    $("#reviews-body").html("<div class='alert alert-danger'>Error loading reviews. Please try again.</div>");
                });
        }, 300);
    }

    function getReviewsWithError(building_name, room_no, clicked_review_button) {
        $("#reviews-body").html("<div class=\"center\"><div class=\"loadingio-spinner-eclipse-sl0eruj4pj9\"><div class=\"ldio-nsjyfj8x68\"><div></div></div></div></div>");
        
        if (clicked_review_button !== null) {
            window.review_button = clicked_review_button;
        }
        
        window.curr_building_name = building_name;
        window.curr_room_no = room_no;
        
        // Make sure body has the rooms-page class for CSS targeting
        $('body').addClass('rooms-page');
        
        // Ensure jQuery Confirm is available
        if (typeof $.confirm !== 'function') {
            console.log("Loading jQuery Confirm for reviews");
            
            // Load jQuery Confirm CSS if needed
            if (!$('link[href*="jquery-confirm"]').length) {
                $('head').append('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css">');
            }
            
            // Load jQuery Confirm JS
            $.getScript("https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js")
                .done(function() {
                    console.log("jQuery Confirm loaded successfully");
                })
                .fail(function() {
                    console.error("Failed to load jQuery Confirm");
                });
        }
        
        // Ensure Bootstrap icons are available
        if (!$('link[href*="bootstrap-icons"]').length) {
            $('head').append('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">');
        }
        
        // Ensure we have a global text_max value for character counting
        if (typeof window.text_max === 'undefined') {
            window.text_max = 5000;
        }
        
        // Show loading indicator
        setTimeout(function() {
            console.log("Fetching reviews (with error context) for", building_name, room_no);
            
            fetchWithTimeout('/get_reviews?' +
                '&building_name=' + building_name +
                '&room_no=' + room_no)
                .then(response => response.text())
                .then(data => {
                    $("#reviews-body").html(data);
                    
                    // Initialize character counter for the review textarea
                    setTimeout(function() {
                        // Use the global initializeCharCounter function if available
                        if (typeof initializeCharCounter === 'function') {
                            initializeCharCounter();
                            console.log("Character counter initialized after loading reviews");
                        }
                        
                        // Make sure the review form is properly set up
                        if ($('#submit-review-form').length) {
                            // Attach event handlers
                            $("#submit-review-form").off("submit").on("submit", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                            
                            // Also attach to submit button click for more reliability
                            $(".submit-button").off("click").on("click", function(e) {
                                e.preventDefault();
                                if (typeof submitReviewWithoutRefresh === 'function') {
                                    submitReviewWithoutRefresh();
                                }
                                return false;
                            });
                        }
                        
                        // Display error message if applicable
                        if (window.errorMessage) {
                            if (window.notyf) {
                                window.notyf.error(window.errorMessage);
                                window.errorMessage = null;
                            }
                        }
                    }, 300);
                })
                .catch(error => {
                    console.error("Error fetching reviews:", error);
                    $("#reviews-body").html("<div class='alert alert-danger'>Error loading reviews. Please try again.</div>");
                });
        }, 300);
    }

    function submitReviewWithoutRefresh() {
        rating = $("#overall-rating").val()
        review = $("#written-review").val()
        let reviewForm = $("form#submit-review-form")[0];
        let formData = new FormData(reviewForm);
        $.ajax({
            type: 'POST',
            url: '/submitReview',
            contentType: false,
            dataType: "json",
            cache: false,
            processData: false,
            data: formData,
            success: function (data, textStatus, jqXHR) {
                $('#submit-review-form').trigger("reset");
                notyf.success(jqXHR.responseJSON.message);
                incrementReviewButton();
                getReviews(window.curr_building_name, window.curr_room_no, null);
            },
            error: function (jqXHR) {
                if (jqXHR.responseJSON.message === 'override') {
                    $.confirm({
                        title: 'You will override your old review with this new review.',
                        buttons: {
                            confirm: {
                                action: function () {
                                    $("#override").val('yes')
                                    reviewForm = $("form#submit-review-form")[0];
                                    formData = new FormData(reviewForm);
                                    $.ajax({
                                        type: 'POST',
                                        url: '/submitReview',
                                        contentType: false,
                                        dataType: "json",
                                        cache: false,
                                        processData: false,
                                        data: formData,
                                        success: function (data, textStatus, jqXHR) {
                                            $('#submit-review-form').trigger("reset");
                                            notyf.success(jqXHR.responseJSON.message);
                                            getReviews(window.curr_building_name, window.curr_room_no, null);
                                        },
                                        error: function (jqXHR) {
                                            notyf.error(jqXHR.responseJSON.message);
                                            getReviewsWithError(window.curr_building_name, window.curr_room_no, null);
                                        }
                                    });
                                },
                                btnClass: 'btn-blue',
                            },
                            cancel: {
                                action: function () {
                                },
                                btnClass: 'btn-red',
                            },
                        }
                    });
                } else {
                    notyf.error(jqXHR.responseJSON.message);
                    getReviewsWithError(window.curr_building_name, window.curr_room_no, null);
                }
            }
        })
    }

</script>
